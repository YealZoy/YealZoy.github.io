<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>郑菲菲_fei</title>
  
  <subtitle>郑菲菲_fei</subtitle>
  <link href="/atom.xml" rel="self"/>
  
  <link href="https://www.zhengyuyan.com/"/>
  <updated>2018-07-17T13:58:07.219Z</updated>
  <id>https://www.zhengyuyan.com/</id>
  
  <author>
    <name>郑玉燕</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>istio metrics(六)</title>
    <link href="https://www.zhengyuyan.com/201807/17/istio-metrics/"/>
    <id>https://www.zhengyuyan.com/201807/17/istio-metrics/</id>
    <published>2018-07-17T13:54:48.000Z</published>
    <updated>2018-07-17T13:58:07.219Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Istio-Metrics"><a href="#Istio-Metrics" class="headerlink" title="Istio Metrics"></a>Istio Metrics</h1><h1 id="Service-Telemetry"><a href="#Service-Telemetry" class="headerlink" title="Service Telemetry"></a>Service Telemetry</h1><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># Configuration for metric instances</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">"config.istio.io/v1alpha2"</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">metric</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">doublerequestcount</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">istio-system</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  value:</span> <span class="string">"2"</span> <span class="comment"># count each request twice</span></span><br><span class="line"><span class="attr">  dimensions:</span></span><br><span class="line"><span class="attr">    source:</span> <span class="string">source.service</span> <span class="string">| "unknown"</span></span><br><span class="line"><span class="string"></span><span class="attr">    destination:</span> <span class="string">destination.service</span> <span class="string">| "unknown"</span></span><br><span class="line"><span class="string"></span><span class="attr">    message:</span> <span class="string">'"twice the fun!"'</span></span><br><span class="line"><span class="attr">  monitored_resource_type:</span> <span class="string">'"UNSPECIFIED"'</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment"># Configuration for a Prometheus handler</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">"config.istio.io/v1alpha2"</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">prometheus</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">doublehandler</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">istio-system</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  metrics:</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">double_request_count</span> <span class="comment"># Prometheus metric name</span></span><br><span class="line"><span class="attr">    instance_name:</span> <span class="string">doublerequestcount.metric.istio-system</span> <span class="comment"># Mixer instance name (fully-qualified)</span></span><br><span class="line"><span class="attr">    kind:</span> <span class="string">COUNTER</span></span><br><span class="line"><span class="attr">    label_names:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">source</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">destination</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">message</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment"># Rule to send metric instances to a Prometheus handler</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">"config.istio.io/v1alpha2"</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">rule</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">doubleprom</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">istio-system</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  actions:</span></span><br><span class="line"><span class="attr">  - handler:</span> <span class="string">doublehandler.prometheus</span></span><br><span class="line"><span class="attr">    instances:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">doublerequestcount.metric</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment"># Configuration for logentry instances</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">"config.istio.io/v1alpha2"</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">logentry</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">newlog</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">istio-system</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  severity:</span> <span class="string">'"warning"'</span></span><br><span class="line"><span class="attr">  timestamp:</span> <span class="string">request.time</span></span><br><span class="line"><span class="attr">  variables:</span></span><br><span class="line"><span class="attr">    source:</span> <span class="string">source.labels["app"]</span> <span class="string">| source.service | "unknown"</span></span><br><span class="line"><span class="string"></span><span class="attr">    user:</span> <span class="string">source.user</span> <span class="string">| "unknown"</span></span><br><span class="line"><span class="string"></span><span class="attr">    destination:</span> <span class="string">destination.labels["app"]</span> <span class="string">| destination.service | "unknown"</span></span><br><span class="line"><span class="string"></span><span class="attr">    responseCode:</span> <span class="string">response.code</span> <span class="string">| 0</span></span><br><span class="line"><span class="string"></span><span class="attr">    responseSize:</span> <span class="string">response.size</span> <span class="string">| 0</span></span><br><span class="line"><span class="string"></span><span class="attr">    latency:</span> <span class="string">response.duration</span> <span class="string">| "0ms"</span></span><br><span class="line"><span class="string"></span><span class="attr">  monitored_resource_type:</span> <span class="string">'"UNSPECIFIED"'</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment"># Configuration for a stdio handler</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">"config.istio.io/v1alpha2"</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">stdio</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">newhandler</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">istio-system</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr"> severity_levels:</span></span><br><span class="line"><span class="attr">   warning:</span> <span class="number">1</span> <span class="comment"># Params.Level.WARNING</span></span><br><span class="line"><span class="attr"> outputAsJson:</span> <span class="literal">true</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment"># Rule to send logentry instances to a stdio handler</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">"config.istio.io/v1alpha2"</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">rule</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">newlogstdio</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">istio-system</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  match:</span> <span class="string">"true"</span> <span class="comment"># match for all requests</span></span><br><span class="line"><span class="attr">  actions:</span></span><br><span class="line"><span class="attr">   - handler:</span> <span class="string">newhandler.stdio</span></span><br><span class="line"><span class="attr">     instances:</span></span><br><span class="line"><span class="bullet">     -</span> <span class="string">newlog.logentry</span></span><br><span class="line"><span class="meta">---</span></span><br></pre></td></tr></table></figure><h1 id="TCP-Telemetry"><a href="#TCP-Telemetry" class="headerlink" title="TCP Telemetry"></a>TCP Telemetry</h1><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># Configuration for a metric measuring bytes sent from a server</span></span><br><span class="line"><span class="comment"># to a client</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">"config.istio.io/v1alpha2"</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">metric</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">mongosentbytes</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  value:</span> <span class="string">connection.sent.bytes</span> <span class="string">| 0 # uses a TCP-specific attribute</span></span><br><span class="line"><span class="string"></span><span class="attr">  dimensions:</span></span><br><span class="line"><span class="attr">    source_service:</span> <span class="string">source.service</span> <span class="string">| "unknown"</span></span><br><span class="line"><span class="string"></span><span class="attr">    source_version:</span> <span class="string">source.labels["version"]</span> <span class="string">| "unknown"</span></span><br><span class="line"><span class="string"></span><span class="attr">    destination_version:</span> <span class="string">destination.labels["version"]</span> <span class="string">| "unknown"</span></span><br><span class="line"><span class="string"></span><span class="attr">  monitoredResourceType:</span> <span class="string">'"UNSPECIFIED"'</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment"># Configuration for a metric measuring bytes sent from a client</span></span><br><span class="line"><span class="comment"># to a server</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">"config.istio.io/v1alpha2"</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">metric</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">mongoreceivedbytes</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  value:</span> <span class="string">connection.received.bytes</span> <span class="string">| 0 # uses a TCP-specific attribute</span></span><br><span class="line"><span class="string"></span><span class="attr">  dimensions:</span></span><br><span class="line"><span class="attr">    source_service:</span> <span class="string">source.service</span> <span class="string">| "unknown"</span></span><br><span class="line"><span class="string"></span><span class="attr">    source_version:</span> <span class="string">source.labels["version"]</span> <span class="string">| "unknown"</span></span><br><span class="line"><span class="string"></span><span class="attr">    destination_version:</span> <span class="string">destination.labels["version"]</span> <span class="string">| "unknown"</span></span><br><span class="line"><span class="string"></span><span class="attr">  monitoredResourceType:</span> <span class="string">'"UNSPECIFIED"'</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment"># Configuration for a Prometheus handler</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">"config.istio.io/v1alpha2"</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">prometheus</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">mongohandler</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  metrics:</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">mongo_sent_bytes</span> <span class="comment"># Prometheus metric name</span></span><br><span class="line"><span class="attr">    instance_name:</span> <span class="string">mongosentbytes.metric.default</span> <span class="comment"># Mixer instance name (fully-qualified)</span></span><br><span class="line"><span class="attr">    kind:</span> <span class="string">COUNTER</span></span><br><span class="line"><span class="attr">    label_names:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">source_service</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">source_version</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">destination_version</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">mongo_received_bytes</span> <span class="comment"># Prometheus metric name</span></span><br><span class="line"><span class="attr">    instance_name:</span> <span class="string">mongoreceivedbytes.metric.default</span> <span class="comment"># Mixer instance name (fully-qualified)</span></span><br><span class="line"><span class="attr">    kind:</span> <span class="string">COUNTER</span></span><br><span class="line"><span class="attr">    label_names:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">source_service</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">source_version</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">destination_version</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment"># Rule to send metric instances to a Prometheus handler</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">"config.istio.io/v1alpha2"</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">rule</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">mongoprom</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  match:</span> <span class="string">context.protocol</span> <span class="string">==</span> <span class="string">"tcp"</span></span><br><span class="line">         <span class="string">&amp;&amp;</span> <span class="string">destination.service</span> <span class="string">==</span> <span class="string">"mongodb.default.svc.cluster.local"</span></span><br><span class="line"><span class="attr">  actions:</span></span><br><span class="line"><span class="attr">  - handler:</span> <span class="string">mongohandler.prometheus</span></span><br><span class="line"><span class="attr">    instances:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">mongoreceivedbytes.metric</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">mongosentbytes.metric</span></span><br></pre></td></tr></table></figure><h1 id="参考文档"><a href="#参考文档" class="headerlink" title="参考文档"></a>参考文档</h1><p><a href="https://kubernetes.feisky.xyz/zh/apps/istio-metrics.html" target="_blank" rel="noopener">istio metrics</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;Istio-Metrics&quot;&gt;&lt;a href=&quot;#Istio-Metrics&quot; class=&quot;headerlink&quot; title=&quot;Istio Metrics&quot;&gt;&lt;/a&gt;Istio Metrics&lt;/h1&gt;&lt;h1 id=&quot;Service-Telemetry&quot;&gt;&lt;a
      
    
    </summary>
    
      <category term="DevOps" scheme="https://www.zhengyuyan.com/categories/DevOps/"/>
    
    
      <category term="service Mesh" scheme="https://www.zhengyuyan.com/tags/service-Mesh/"/>
    
  </entry>
  
  <entry>
    <title>istio策略管理(五)</title>
    <link href="https://www.zhengyuyan.com/201807/17/istio-policy/"/>
    <id>https://www.zhengyuyan.com/201807/17/istio-policy/</id>
    <published>2018-07-17T13:51:44.000Z</published>
    <updated>2018-07-17T13:58:38.869Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Istio-策略管理"><a href="#Istio-策略管理" class="headerlink" title="Istio 策略管理"></a>Istio 策略管理</h1><p>Mixer 为应用程序和基础架构后端之间提供了一个通用的策略控制层，负责先决条件检查（如认证授权）、配额管理并从 Envoy 代理中收集遥测数据等。<br><figure class="image-bubble">                <div class="img-lightbox">                    <div class="overlay"></div>                    <img src="/img/istio-mixer.png" alt="" title="">                </div>                <div class="image-caption"></div>            </figure><br>Mixer 支持灵活的插件模型（即 Adapters），支持 GCP、AWS、Prometheus、Heapster 等各种丰富功能的后端。<br><figure class="image-bubble">                <div class="img-lightbox">                    <div class="overlay"></div>                    <img src="istio-adapters.png" alt="" title="">                </div>                <div class="image-caption"></div>            </figure></p><h1 id="实现原理"><a href="#实现原理" class="headerlink" title="实现原理"></a>实现原理</h1><p>本质上，Mixer 是一个 属性 处理机，进入 Mixer 的请求带有一系列的属性，Mixer 按照不同的处理阶段处理：</p><ul><li>通过全局 Adapters 为请求引入新的属性</li><li>通过解析（Resolution）识别要用于处理请求的配置资源</li><li>处理属性，生成 Adapter 参数</li><li>分发请求到各个 Adapters 后端处理<figure class="image-bubble">                <div class="img-lightbox">                    <div class="overlay"></div>                    <img src="/img/istio-phase.png" alt="" title="">                </div>                <div class="image-caption"></div>            </figure>Adapters 后端以 Mixer 配置 的方式注册到 Istio 中，参考<a href="https://raw.githubusercontent.com/istio/istio/master/samples/bookinfo/kube/mixer-rule-ratings-ratelimit.yaml" target="_blank" rel="noopener">这里</a>查看示例配置</li></ul><h1 id="流量限制示例"><a href="#流量限制示例" class="headerlink" title="流量限制示例"></a>流量限制示例</h1><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">"config.istio.io/v1alpha2"</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">memquota</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">handler</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">istio-system</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  quotas:</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">requestcount.quota.istio-system</span></span><br><span class="line"><span class="attr">    maxAmount:</span> <span class="number">5000</span></span><br><span class="line"><span class="attr">    validDuration:</span> <span class="number">1</span><span class="string">s</span></span><br><span class="line">    <span class="comment"># The first matching override is applied.</span></span><br><span class="line">    <span class="comment"># A requestcount instance is checked against override dimensions.</span></span><br><span class="line"><span class="attr">    overrides:</span></span><br><span class="line">    <span class="comment"># The following override applies to 'ratings' when</span></span><br><span class="line">    <span class="comment"># the source is 'reviews'.</span></span><br><span class="line"><span class="attr">    - dimensions:</span></span><br><span class="line"><span class="attr">        destination:</span> <span class="string">ratings</span></span><br><span class="line"><span class="attr">        source:</span> <span class="string">reviews</span></span><br><span class="line"><span class="attr">      maxAmount:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">      validDuration:</span> <span class="number">1</span><span class="string">s</span></span><br><span class="line">    <span class="comment"># The following override applies to 'ratings' regardless</span></span><br><span class="line">    <span class="comment"># of the source.</span></span><br><span class="line"><span class="attr">    - dimensions:</span></span><br><span class="line"><span class="attr">        destination:</span> <span class="string">ratings</span></span><br><span class="line"><span class="attr">      maxAmount:</span> <span class="number">100</span></span><br><span class="line"><span class="attr">      validDuration:</span> <span class="number">1</span><span class="string">s</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">"config.istio.io/v1alpha2"</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">quota</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">requestcount</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">istio-system</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  dimensions:</span></span><br><span class="line"><span class="attr">    source:</span> <span class="string">source.labels["app"]</span> <span class="string">| source.service | "unknown"</span></span><br><span class="line"><span class="string"></span><span class="attr">    sourceVersion:</span> <span class="string">source.labels["version"]</span> <span class="string">| "unknown"</span></span><br><span class="line"><span class="string"></span><span class="attr">    destination:</span> <span class="string">destination.labels["app"]</span> <span class="string">| destination.service | "unknown"</span></span><br><span class="line"><span class="string"></span><span class="attr">    destinationVersion:</span> <span class="string">destination.labels["version"]</span> <span class="string">| "unknown"</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">---</span></span><br><span class="line"><span class="string"></span><span class="attr">apiVersion:</span> <span class="string">"config.istio.io/v1alpha2"</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">rule</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">quota</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">istio-system</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  actions:</span></span><br><span class="line"><span class="attr">  - handler:</span> <span class="string">handler.memquota</span></span><br><span class="line"><span class="attr">    instances:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">requestcount.quota</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">config.istio.io/v1alpha2</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">QuotaSpec</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  creationTimestamp:</span> <span class="literal">null</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">request-count</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">istio-system</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  rules:</span></span><br><span class="line"><span class="attr">  - quotas:</span></span><br><span class="line"><span class="attr">    - charge:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">      quota:</span> <span class="string">RequestCount</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">config.istio.io/v1alpha2</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">QuotaSpecBinding</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  creationTimestamp:</span> <span class="literal">null</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">request-count</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">istio-system</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  quotaSpecs:</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">request-count</span></span><br><span class="line"><span class="attr">    namespace:</span> <span class="string">istio-system</span></span><br><span class="line"><span class="attr">  services:</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">ratings</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">reviews</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">details</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">productpage</span></span><br></pre></td></tr></table></figure><h1 id="参考文档"><a href="#参考文档" class="headerlink" title="参考文档"></a>参考文档</h1><p><a href="https://kubernetes.feisky.xyz/zh/apps/istio-policy.html" target="_blank" rel="noopener">istio策略管理</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;Istio-策略管理&quot;&gt;&lt;a href=&quot;#Istio-策略管理&quot; class=&quot;headerlink&quot; title=&quot;Istio 策略管理&quot;&gt;&lt;/a&gt;Istio 策略管理&lt;/h1&gt;&lt;p&gt;Mixer 为应用程序和基础架构后端之间提供了一个通用的策略控制层，负责先决
      
    
    </summary>
    
      <category term="DevOps" scheme="https://www.zhengyuyan.com/categories/DevOps/"/>
    
    
      <category term="service Mesh" scheme="https://www.zhengyuyan.com/tags/service-Mesh/"/>
    
  </entry>
  
  <entry>
    <title>istio安全管理(四)</title>
    <link href="https://www.zhengyuyan.com/201807/17/istio-aq/"/>
    <id>https://www.zhengyuyan.com/201807/17/istio-aq/</id>
    <published>2018-07-17T13:48:36.000Z</published>
    <updated>2018-07-17T13:58:34.841Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Istio-安全管理"><a href="#Istio-安全管理" class="headerlink" title="Istio 安全管理"></a>Istio 安全管理</h1><p>Istio 提供了 RBAC 访问控制以及双向 TLS 认证等安全管理功能。</p><h1 id="RBAC"><a href="#RBAC" class="headerlink" title="RBAC"></a>RBAC</h1><p>Istio Role-Based Access Control (RBAC) 提供了 namespace、service 以及 method 级别的访问控制。其特性包括</p><ul><li>简单易用：提供基于角色的语意</li><li>支持认证：提供服务 - 服务和用户 - 服务的认证</li><li>灵活：提供角色和角色绑定的自定义属性<figure class="image-bubble">                <div class="img-lightbox">                    <div class="overlay"></div>                    <img src="/img/rbac.png" alt="" title="">                </div>                <div class="image-caption"></div>            </figure></li></ul><h1 id="开启RBAC"><a href="#开启RBAC" class="headerlink" title="开启RBAC"></a>开启RBAC</h1><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># Enable RBAC for default namespace</span></span><br><span class="line"><span class="string">istioctl</span> <span class="string">create</span> <span class="bullet">-f</span> <span class="string">samples/bookinfo/kube/istio-rbac-enable.yaml</span></span><br></pre></td></tr></table></figure><h1 id="实现原理"><a href="#实现原理" class="headerlink" title="实现原理"></a>实现原理</h1><p>在实现原理上，Istio RBAC 作为 Mixer Adaper 对请求上下文（Request Context）进行认证，并返回授权结果：ALLOW 或者 DENY。请求上下文包含访问对象和动作等两部分，如<br><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">"config.istio.io/v1alpha2"</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">authorization</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">requestcontext</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">istio-system</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  subject:</span></span><br><span class="line"><span class="attr">    user:</span> <span class="string">source.user</span> <span class="string">| ""</span></span><br><span class="line"><span class="string"></span><span class="attr">    groups:</span> <span class="string">""</span></span><br><span class="line"><span class="attr">    properties:</span></span><br><span class="line"><span class="attr">      app:</span> <span class="string">source.labels["app"]</span> <span class="string">| ""</span></span><br><span class="line"><span class="string"></span><span class="attr">      version:</span> <span class="string">source.labels["version"]</span> <span class="string">| ""</span></span><br><span class="line"><span class="string"></span><span class="attr">      namespace:</span> <span class="string">source.namespace</span> <span class="string">| ""</span></span><br><span class="line"><span class="string"></span><span class="attr">  action:</span></span><br><span class="line"><span class="attr">    namespace:</span> <span class="string">destination.namespace</span> <span class="string">| ""</span></span><br><span class="line"><span class="string"></span><span class="attr">    service:</span> <span class="string">destination.service</span> <span class="string">| ""</span></span><br><span class="line"><span class="string"></span><span class="attr">    method:</span> <span class="string">request.method</span> <span class="string">| ""</span></span><br><span class="line"><span class="string"></span><span class="attr">    path:</span> <span class="string">request.path</span> <span class="string">| ""</span></span><br><span class="line"><span class="string"></span><span class="attr">    properties:</span></span><br><span class="line"><span class="attr">      app:</span> <span class="string">destination.labels["app"]</span> <span class="string">| ""</span></span><br><span class="line"><span class="string"></span><span class="attr">      version:</span> <span class="string">destination.labels["version"]</span> <span class="string">| ""</span></span><br><span class="line"><span class="string">---</span></span><br><span class="line"><span class="string"></span><span class="attr">apiVersion:</span> <span class="string">"config.istio.io/v1alpha2"</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">rbac</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">handler</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">istio-system</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  config_store_url:</span> <span class="string">"k8s://"</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">"config.istio.io/v1alpha2"</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">rule</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">rbaccheck</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">istio-system</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  match:</span> <span class="string">destination.namespace</span> <span class="string">==</span> <span class="string">"default"</span></span><br><span class="line"><span class="attr">  actions:</span></span><br><span class="line"><span class="attr">  - handler:</span> <span class="string">handler.rbac</span></span><br><span class="line"><span class="attr">    instances:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">requestcontext.authorization</span></span><br></pre></td></tr></table></figure></p><h1 id="访问控制"><a href="#访问控制" class="headerlink" title="访问控制"></a>访问控制</h1><p>Istio RBAC 提供了 ServiceRole 和 ServiceRoleBinding 两种资源对象，并以 CustomResourceDefinition (CRD) 的方式管理。</p><ul><li>ServiceRole 定义了一个可访问特定资源（namespace 之内）的服务角色，并支持以前缀通配符和后缀通配符的形式匹配一组服务</li><li>ServiceRoleBinding 定义了赋予指定角色的绑定，即可以指定的角色和动作访问服务<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">"config.istio.io/v1alpha2"</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ServiceRole</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">service-viewer</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  rules:</span></span><br><span class="line"><span class="attr">  - services:</span> <span class="string">["*"]</span></span><br><span class="line"><span class="attr">    methods:</span> <span class="string">["GET"]</span></span><br><span class="line"><span class="attr">    constraints:</span></span><br><span class="line"><span class="attr">    - key:</span> <span class="string">"app"</span></span><br><span class="line"><span class="attr">      values:</span> <span class="string">["productpage",</span> <span class="string">"details"</span><span class="string">,</span> <span class="string">"reviews"</span><span class="string">,</span> <span class="string">"ratings"</span><span class="string">]</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">"config.istio.io/v1alpha2"</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ServiceRoleBinding</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">bind-service-viewer</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  subjects:</span></span><br><span class="line"><span class="attr">  - properties:</span></span><br><span class="line"><span class="attr">      namespace:</span> <span class="string">"default"</span></span><br><span class="line"><span class="attr">  - properties:</span></span><br><span class="line"><span class="attr">      namespace:</span> <span class="string">"istio-system"</span></span><br><span class="line"><span class="attr">  roleRef:</span></span><br><span class="line"><span class="attr">    kind:</span> <span class="string">ServiceRole</span></span><br><span class="line"><span class="attr">    name:</span> <span class="string">"service-viewer"</span></span><br></pre></td></tr></table></figure></li></ul><h1 id="双向-TLS"><a href="#双向-TLS" class="headerlink" title="双向 TLS"></a>双向 TLS</h1><p>双向 TLS 为服务间通信提供了 TLS 认证，并提供管理系统自动管理密钥和证书的生成、分发、替换以及撤销。<br><figure class="image-bubble">                <div class="img-lightbox">                    <div class="overlay"></div>                    <img src="/img/istio-tls.png" alt="" title="">                </div>                <div class="image-caption"></div>            </figure></p><h2 id="实现原理-1"><a href="#实现原理-1" class="headerlink" title="实现原理"></a>实现原理</h2><p>Istio Auth 由三部分组成：</p><ul><li>身份（Identity）：Istio 使用 Kubernetes service account 来识别服务的身份，格式为 spiffe://&lt;<em>domain</em>&gt;/ns/&lt;<em>namespace</em>&gt;/sa/&lt;<em>serviceaccount</em>&gt;</li><li>通信安全：端到端 TLS 通信通过服务器端和客户端的 Envoy 容器完成</li><li>证书管理：Istio CA (Certificate Authority) 负责为每个 service account 生成 SPIFEE 密钥和证书、分发到 Pod（通过 Secret Volume Mount 的形式）、定期轮转（Rotate）以及必要时撤销。对于 Kuberentes 之外的服务，CA 配合 Istio node agent 共同完成整个过程。</li></ul><p>这样，一个容器使用证书的流程为</p><ul><li>首先，Istio CA 监听 Kubernetes API，并为 service account 生成 SPIFFE 密钥及证书，再以 secret 形式存储到 Kubernetes 中</li><li>然后，Pod 创建时，Kubernetes API Server 将 secret 挂载到容器中</li><li>最后，Pilot 生成一个访问控制的配置，定义哪些 service account 可以访问服务，并分发给 Envoy</li><li>而当容器间通信时，Pod 双方的 Envoy 就会基于访问控制配置来作认证</li></ul><h1 id="最佳实践"><a href="#最佳实践" class="headerlink" title="最佳实践"></a>最佳实践</h1><ul><li>为不同团队创建不同 namespace 分别管理</li><li>将 Istio CA 运行在单独的 namespace 中，并且仅授予管理员权限</li></ul><h1 id="参考文档"><a href="#参考文档" class="headerlink" title="参考文档"></a>参考文档</h1><p><a href="https://kubernetes.feisky.xyz/zh/apps/istio-security.html" target="_blank" rel="noopener">istio安全管理</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;Istio-安全管理&quot;&gt;&lt;a href=&quot;#Istio-安全管理&quot; class=&quot;headerlink&quot; title=&quot;Istio 安全管理&quot;&gt;&lt;/a&gt;Istio 安全管理&lt;/h1&gt;&lt;p&gt;Istio 提供了 RBAC 访问控制以及双向 TLS 认证等安全管理功能。
      
    
    </summary>
    
      <category term="DevOps" scheme="https://www.zhengyuyan.com/categories/DevOps/"/>
    
    
      <category term="service Mesh" scheme="https://www.zhengyuyan.com/tags/service-Mesh/"/>
    
  </entry>
  
  <entry>
    <title>istio流量管理(三)</title>
    <link href="https://www.zhengyuyan.com/201807/17/istio-traffic/"/>
    <id>https://www.zhengyuyan.com/201807/17/istio-traffic/</id>
    <published>2018-07-17T13:43:40.000Z</published>
    <updated>2018-07-17T13:58:29.683Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Istio-流量管理"><a href="#Istio-流量管理" class="headerlink" title="Istio 流量管理"></a>Istio 流量管理</h1><p>Istio 提供了强大的流量管理功能，如智能路由、服务发现与负载均衡、故障恢复、故障注入等。<br><figure class="image-bubble">                <div class="img-lightbox">                    <div class="overlay"></div>                    <img src="/img/istio-traffic-manage.png" alt="" title="">                </div>                <div class="image-caption"></div>            </figure><br>流量管理的功能由 Pilot 配合 Envoy 负责，并接管进入和离开容器的所有流量：<br><figure class="image-bubble">                <div class="img-lightbox">                    <div class="overlay"></div>                    <img src="/img/istio-request-flow.png" alt="" title="">                </div>                <div class="image-caption"></div>            </figure></p><h1 id="API-版本"><a href="#API-版本" class="headerlink" title="API 版本"></a>API 版本</h1><p>Istio 0.7.X 及以前版本仅支持 config.istio.io/v1alpha2，0.8.0 将其升级为 networking.istio.io/v1alpha3，并且重命名了流量管理的几个资源对象：</p><ul><li>RouteRule -&gt; VirtualService</li><li>DestinationPolicy -&gt; DestinationRule</li><li>EgressRule -&gt; ExternalService</li><li>Ingress -&gt; Gateway</li></ul><h1 id="服务发现和负载均衡"><a href="#服务发现和负载均衡" class="headerlink" title="服务发现和负载均衡"></a>服务发现和负载均衡</h1><p>为了接管流量，Istio 假设所有容器在启动时自动将自己注册到 Istio 中（通过自动或手动给 Pod 注入 Envoy sidecar 容器）。Envoy 收到外部请求后，会对请求作负载均衡，并支持轮询、随机和加权最少请求等负载均衡算法。除此之外，Envoy 还会以熔断机制定期检查服务后端容器的健康状态，自动移除不健康的容器和加回恢复正常的容器。容器内也可以返回 HTTP 503 显示将自己从负载均衡中移除。<br><figure class="image-bubble">                <div class="img-lightbox">                    <div class="overlay"></div>                    <img src="/img/istio-service-discovery.png" alt="" title="">                </div>                <div class="image-caption"></div>            </figure></p><h1 id="流量接管原理"><a href="#流量接管原理" class="headerlink" title="流量接管原理"></a>流量接管原理</h1><p>Envoy sidecar 使用 iptables 把进入 Pod 和从 Pod 发出的流量转发到 Envoy 进程监听的端口（即 15001 端口）上：<br><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># Generated by iptables-save v1.6.0 on Fri Jun  8 07:37:33 2018</span></span><br><span class="line"><span class="meta">*mangle</span></span><br><span class="line"><span class="string">:PREROUTING</span> <span class="string">ACCEPT</span> <span class="string">[2883:1129969]</span></span><br><span class="line"><span class="string">:INPUT</span> <span class="string">ACCEPT</span> <span class="string">[2883:1129969]</span></span><br><span class="line"><span class="string">:FORWARD</span> <span class="string">ACCEPT</span> <span class="string">[0:0]</span></span><br><span class="line"><span class="string">:OUTPUT</span> <span class="string">ACCEPT</span> <span class="string">[58217:6662600]</span></span><br><span class="line"><span class="string">:POSTROUTING</span> <span class="string">ACCEPT</span> <span class="string">[58217:6662600]</span></span><br><span class="line"><span class="string">COMMIT</span></span><br><span class="line"><span class="comment"># Completed on Fri Jun  8 07:37:33 2018</span></span><br><span class="line"><span class="comment"># Generated by iptables-save v1.6.0 on Fri Jun  8 07:37:33 2018</span></span><br><span class="line"><span class="meta">*nat</span></span><br><span class="line"><span class="string">:PREROUTING</span> <span class="string">ACCEPT</span> <span class="string">[0:0]</span></span><br><span class="line"><span class="string">:INPUT</span> <span class="string">ACCEPT</span> <span class="string">[0:0]</span></span><br><span class="line"><span class="string">:OUTPUT</span> <span class="string">ACCEPT</span> <span class="string">[299:27815]</span></span><br><span class="line"><span class="string">:POSTROUTING</span> <span class="string">ACCEPT</span> <span class="string">[299:27815]</span></span><br><span class="line"><span class="string">:ISTIO_INBOUND</span> <span class="bullet">-</span> <span class="string">[0:0]</span></span><br><span class="line"><span class="string">:ISTIO_OUTPUT</span> <span class="bullet">-</span> <span class="string">[0:0]</span></span><br><span class="line"><span class="string">:ISTIO_REDIRECT</span> <span class="bullet">-</span> <span class="string">[0:0]</span></span><br><span class="line"><span class="bullet">-</span><span class="string">A</span> <span class="string">PREROUTING</span> <span class="bullet">-p</span> <span class="string">tcp</span> <span class="bullet">-j</span> <span class="string">ISTIO_INBOUND</span></span><br><span class="line"><span class="bullet">-</span><span class="string">A</span> <span class="string">OUTPUT</span> <span class="bullet">-p</span> <span class="string">tcp</span> <span class="bullet">-j</span> <span class="string">ISTIO_OUTPUT</span></span><br><span class="line"><span class="bullet">-</span><span class="string">A</span> <span class="string">ISTIO_INBOUND</span> <span class="bullet">-p</span> <span class="string">tcp</span> <span class="bullet">-m</span> <span class="string">tcp</span> <span class="bullet">--dport</span> <span class="number">9080</span> <span class="bullet">-j</span> <span class="string">ISTIO_REDIRECT</span></span><br><span class="line"><span class="bullet">-</span><span class="string">A</span> <span class="string">ISTIO_OUTPUT</span> <span class="string">!</span> <span class="bullet">-d</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="string">/32</span> <span class="bullet">-o</span> <span class="string">lo</span> <span class="bullet">-j</span> <span class="string">ISTIO_REDIRECT</span></span><br><span class="line"><span class="bullet">-</span><span class="string">A</span> <span class="string">ISTIO_OUTPUT</span> <span class="bullet">-m</span> <span class="string">owner</span> <span class="bullet">--uid-owner</span> <span class="number">1337</span> <span class="bullet">-j</span> <span class="string">RETURN</span></span><br><span class="line"><span class="bullet">-</span><span class="string">A</span> <span class="string">ISTIO_OUTPUT</span> <span class="bullet">-m</span> <span class="string">owner</span> <span class="bullet">--gid-owner</span> <span class="number">1337</span> <span class="bullet">-j</span> <span class="string">RETURN</span></span><br><span class="line"><span class="bullet">-</span><span class="string">A</span> <span class="string">ISTIO_OUTPUT</span> <span class="bullet">-d</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="string">/32</span> <span class="bullet">-j</span> <span class="string">RETURN</span></span><br><span class="line"><span class="bullet">-</span><span class="string">A</span> <span class="string">ISTIO_OUTPUT</span> <span class="bullet">-j</span> <span class="string">ISTIO_REDIRECT</span></span><br><span class="line"><span class="bullet">-</span><span class="string">A</span> <span class="string">ISTIO_REDIRECT</span> <span class="bullet">-p</span> <span class="string">tcp</span> <span class="bullet">-j</span> <span class="string">REDIRECT</span> <span class="bullet">--to-ports</span> <span class="number">15001</span></span><br><span class="line"><span class="string">COMMIT</span></span><br><span class="line"><span class="comment"># Completed on Fri Jun  8 07:37:33 2018</span></span><br></pre></td></tr></table></figure></p><h1 id="故障恢复"><a href="#故障恢复" class="headerlink" title="故障恢复"></a>故障恢复</h1><p>Istio 提供了一系列开箱即用的故障恢复功能，如</p><ul><li>超时处理</li><li>重试处理，如限制最大重试时间以及可变重试间隔</li><li>健康检查，如自动移除不健康的容器</li><li>请求限制，如并发请求数和并发连接数</li><li>熔断</li></ul><p>这些功能均可以使用 VirtualService 动态配置。比如以下为用户 jason 的请求返回 500 （而其他用户均可正常访问）：<br><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.istio.io/v1alpha3</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">VirtualService</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">ratings</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  hosts:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">ratings</span></span><br><span class="line"><span class="attr">  http:</span></span><br><span class="line"><span class="attr">  - match:</span></span><br><span class="line"><span class="attr">    - headers:</span></span><br><span class="line"><span class="attr">        cookie:</span></span><br><span class="line"><span class="attr">          regex:</span> <span class="string">"^(.*?;)?(user=jason)(;.*)?$"</span></span><br><span class="line"><span class="attr">    fault:</span></span><br><span class="line"><span class="attr">      abort:</span></span><br><span class="line"><span class="attr">        percent:</span> <span class="number">100</span></span><br><span class="line"><span class="attr">        httpStatus:</span> <span class="number">500</span></span><br><span class="line"><span class="attr">    route:</span></span><br><span class="line"><span class="attr">    - destination:</span></span><br><span class="line"><span class="attr">        host:</span> <span class="string">ratings</span></span><br><span class="line"><span class="attr">        subset:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">  - route:</span></span><br><span class="line"><span class="attr">    - destination:</span></span><br><span class="line"><span class="attr">        host:</span> <span class="string">ratings</span></span><br><span class="line"><span class="attr">        subset:</span> <span class="string">v1</span></span><br></pre></td></tr></table></figure></p><p>熔断示例：<br><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.istio.io/v1alpha3</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">DestinationRule</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">httpbin</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  host:</span> <span class="string">httpbin</span></span><br><span class="line"><span class="attr">  trafficPolicy:</span></span><br><span class="line"><span class="attr">    connectionPool:</span></span><br><span class="line"><span class="attr">      tcp:</span></span><br><span class="line"><span class="attr">        maxConnections:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">      http:</span></span><br><span class="line"><span class="attr">        http1MaxPendingRequests:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">        maxRequestsPerConnection:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">    outlierDetection:</span></span><br><span class="line"><span class="attr">      http:</span></span><br><span class="line"><span class="attr">        consecutiveErrors:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">        interval:</span> <span class="number">1</span><span class="string">s</span></span><br><span class="line"><span class="attr">        baseEjectionTime:</span> <span class="number">3</span><span class="string">m</span></span><br><span class="line"><span class="attr">        maxEjectionPercent:</span> <span class="number">100</span></span><br></pre></td></tr></table></figure></p><h1 id="故障注入"><a href="#故障注入" class="headerlink" title="故障注入"></a>故障注入</h1><p>Istio 支持为应用注入故障，以模拟实际生产中碰到的各种问题，包括</p><ul><li>注入延迟（模拟网络延迟和服务过载）</li><li>注入失败（模拟应用失效）<br>这些故障均可以使用 VirtualService 动态配置。如以下配置 2 秒的延迟：<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.istio.io/v1alpha3</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">VirtualService</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">ratings</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  hosts:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">ratings</span></span><br><span class="line"><span class="attr">  http:</span></span><br><span class="line"><span class="attr">  - fault:</span></span><br><span class="line"><span class="attr">      delay:</span></span><br><span class="line"><span class="attr">        percent:</span> <span class="number">100</span></span><br><span class="line"><span class="attr">        fixedDelay:</span> <span class="number">2</span><span class="string">s</span></span><br><span class="line"><span class="attr">    route:</span></span><br><span class="line"><span class="attr">    - destination:</span></span><br><span class="line"><span class="attr">        host:</span> <span class="string">ratings</span></span><br><span class="line"><span class="attr">        subset:</span> <span class="string">v1</span></span><br></pre></td></tr></table></figure></li></ul><h1 id="金丝雀部署"><a href="#金丝雀部署" class="headerlink" title="金丝雀部署"></a>金丝雀部署</h1><figure class="image-bubble">                <div class="img-lightbox">                    <div class="overlay"></div>                    <img src="/img/istio-service-versions.png" alt="" title="">                </div>                <div class="image-caption"></div>            </figure><p>首先部署 bookinfo，并配置默认路由为 v1 版本：<br><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.istio.io/v1alpha3</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">VirtualService</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">productpage</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  hosts:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">productpage</span></span><br><span class="line"><span class="attr">  gateways:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">bookinfo</span></span><br><span class="line"><span class="attr">  http:</span></span><br><span class="line"><span class="attr">  - route:</span></span><br><span class="line"><span class="attr">    - destination:</span></span><br><span class="line"><span class="attr">        host:</span> <span class="string">productpage</span></span><br><span class="line"><span class="attr">        subset:</span> <span class="string">v1</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.istio.io/v1alpha3</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">VirtualService</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">reviews</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  hosts:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">reviews</span></span><br><span class="line"><span class="attr">  http:</span></span><br><span class="line"><span class="attr">  - route:</span></span><br><span class="line"><span class="attr">    - destination:</span></span><br><span class="line"><span class="attr">        host:</span> <span class="string">reviews</span></span><br><span class="line"><span class="attr">        subset:</span> <span class="string">v1</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.istio.io/v1alpha3</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">VirtualService</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">ratings</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  hosts:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">ratings</span></span><br><span class="line"><span class="attr">  http:</span></span><br><span class="line"><span class="attr">  - route:</span></span><br><span class="line"><span class="attr">    - destination:</span></span><br><span class="line"><span class="attr">        host:</span> <span class="string">ratings</span></span><br><span class="line"><span class="attr">        subset:</span> <span class="string">v1</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.istio.io/v1alpha3</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">VirtualService</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">details</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  hosts:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">details</span></span><br><span class="line"><span class="attr">  http:</span></span><br><span class="line"><span class="attr">  - route:</span></span><br><span class="line"><span class="attr">    - destination:</span></span><br><span class="line"><span class="attr">        host:</span> <span class="string">details</span></span><br><span class="line"><span class="attr">        subset:</span> <span class="string">v1</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.istio.io/v1alpha3</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">DestinationRule</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">productpage</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  host:</span> <span class="string">productpage</span></span><br><span class="line"><span class="attr">  subsets:</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">    labels:</span></span><br><span class="line"><span class="attr">      version:</span> <span class="string">v1</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.istio.io/v1alpha3</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">DestinationRule</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">reviews</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  host:</span> <span class="string">reviews</span></span><br><span class="line"><span class="attr">  subsets:</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">    labels:</span></span><br><span class="line"><span class="attr">      version:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">v2</span></span><br><span class="line"><span class="attr">    labels:</span></span><br><span class="line"><span class="attr">      version:</span> <span class="string">v2</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">v3</span></span><br><span class="line"><span class="attr">    labels:</span></span><br><span class="line"><span class="attr">      version:</span> <span class="string">v3</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.istio.io/v1alpha3</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">DestinationRule</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">ratings</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  host:</span> <span class="string">ratings</span></span><br><span class="line"><span class="attr">  subsets:</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">    labels:</span></span><br><span class="line"><span class="attr">      version:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">v2</span></span><br><span class="line"><span class="attr">    labels:</span></span><br><span class="line"><span class="attr">      version:</span> <span class="string">v2</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">v2-mysql</span></span><br><span class="line"><span class="attr">    labels:</span></span><br><span class="line"><span class="attr">      version:</span> <span class="string">v2-mysql</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">v2-mysql-vm</span></span><br><span class="line"><span class="attr">    labels:</span></span><br><span class="line"><span class="attr">      version:</span> <span class="string">v2-mysql-vm</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.istio.io/v1alpha3</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">DestinationRule</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">details</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  host:</span> <span class="string">details</span></span><br><span class="line"><span class="attr">  subsets:</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">    labels:</span></span><br><span class="line"><span class="attr">      version:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">v2</span></span><br><span class="line"><span class="attr">    labels:</span></span><br><span class="line"><span class="attr">      version:</span> <span class="string">v2</span></span><br><span class="line"><span class="meta">---</span></span><br></pre></td></tr></table></figure></p><p>示例一：将 10% 请求发送到 v2 版本而其余 90% 发送到 v1 版本<br><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.istio.io/v1alpha3</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">VirtualService</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">reviews</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  hosts:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">reviews</span></span><br><span class="line"><span class="attr">  http:</span></span><br><span class="line"><span class="attr">  - route:</span></span><br><span class="line"><span class="attr">    - destination:</span></span><br><span class="line"><span class="attr">        host:</span> <span class="string">reviews</span></span><br><span class="line"><span class="attr">        subset:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">      weight:</span> <span class="number">90</span></span><br><span class="line"><span class="attr">    - destination:</span></span><br><span class="line"><span class="attr">        host:</span> <span class="string">reviews</span></span><br><span class="line"><span class="attr">        subset:</span> <span class="string">v2</span></span><br><span class="line"><span class="attr">      weight:</span> <span class="number">10</span></span><br></pre></td></tr></table></figure></p><p>示例二：将 jason 用户的请求全部发到 v2 版本<br><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.istio.io/v1alpha3</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">VirtualService</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">reviews</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  hosts:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">reviews</span></span><br><span class="line"><span class="attr">  http:</span></span><br><span class="line"><span class="attr">  - match:</span></span><br><span class="line"><span class="attr">    - headers:</span></span><br><span class="line"><span class="attr">        cookie:</span></span><br><span class="line"><span class="attr">          regex:</span> <span class="string">"^(.*?;)?(user=jason)(;.*)?$"</span></span><br><span class="line"><span class="attr">    route:</span></span><br><span class="line"><span class="attr">    - destination:</span></span><br><span class="line"><span class="attr">        host:</span> <span class="string">reviews</span></span><br><span class="line"><span class="attr">        subset:</span> <span class="string">v2</span></span><br><span class="line"><span class="attr">  - route:</span></span><br><span class="line"><span class="attr">    - destination:</span></span><br><span class="line"><span class="attr">        host:</span> <span class="string">reviews</span></span><br><span class="line"><span class="attr">        subset:</span> <span class="string">v1</span></span><br></pre></td></tr></table></figure></p><p>示例三：全部切换到 v2 版本<br><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.istio.io/v1alpha3</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">VirtualService</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">reviews</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  hosts:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">reviews</span></span><br><span class="line"><span class="attr">  http:</span></span><br><span class="line"><span class="attr">  - route:</span></span><br><span class="line"><span class="attr">    - destination:</span></span><br><span class="line"><span class="attr">        host:</span> <span class="string">reviews</span></span><br><span class="line"><span class="attr">        subset:</span> <span class="string">v2</span></span><br></pre></td></tr></table></figure></p><p>示例四：限制并发访问<br><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.istio.io/v1alpha3</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">DestinationRule</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">reviews</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  host:</span> <span class="string">reviews</span></span><br><span class="line"><span class="attr">  subsets:</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">    labels:</span></span><br><span class="line"><span class="attr">      version:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">    trafficPolicy:</span></span><br><span class="line"><span class="attr">      connectionPool:</span></span><br><span class="line"><span class="attr">        tcp:</span></span><br><span class="line"><span class="attr">          maxConnections:</span> <span class="number">100</span></span><br></pre></td></tr></table></figure></p><h1 id="Istio-Ingress"><a href="#Istio-Ingress" class="headerlink" title="Istio Ingress"></a>Istio Ingress</h1><p>Istio 在部署时会自动创建一个 Istio Gateway，用来控制 Ingress 访问。<br><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># prepare自动注入</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">apply</span> <span class="bullet">-f</span> <span class="string">samples/httpbin/httpbin.yaml</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># get ingress external IP (suppose load balancer service)</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">get</span> <span class="string">svc</span> <span class="string">istio-ingressgateway</span> <span class="bullet">-n</span> <span class="string">istio-system</span></span><br><span class="line"><span class="string">export</span> <span class="string">INGRESS_HOST=$(kubectl</span> <span class="bullet">-n</span> <span class="string">istio-system</span> <span class="string">get</span> <span class="string">service</span> <span class="string">istio-ingressgateway</span> <span class="bullet">-o</span> <span class="string">jsonpath='&#123;.status.loadBalancer.ingress[0].ip&#125;')</span></span><br><span class="line"><span class="string">export</span> <span class="string">INGRESS_PORT=$(kubectl</span> <span class="bullet">-n</span> <span class="string">istio-system</span> <span class="string">get</span> <span class="string">service</span> <span class="string">istio-ingressgateway</span> <span class="bullet">-o</span> <span class="string">jsonpath='&#123;.spec.ports[?(@.name=="http")].port&#125;')</span></span><br><span class="line"><span class="string">export</span> <span class="string">SECURE_INGRESS_PORT=$(kubectl</span> <span class="bullet">-n</span> <span class="string">istio-system</span> <span class="string">get</span> <span class="string">service</span> <span class="string">istio-ingressgateway</span> <span class="bullet">-o</span> <span class="string">jsonpath='&#123;.spec.ports[?(@.name=="https")].port&#125;')</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># create gateway</span></span><br><span class="line"><span class="string">cat</span> <span class="string">&lt;&lt;EOF</span> <span class="string">| istioctl create -f -</span></span><br><span class="line"><span class="string"></span><span class="attr">apiVersion:</span> <span class="string">networking.istio.io/v1alpha3</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Gateway</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">httpbin-gateway</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  selector:</span></span><br><span class="line"><span class="attr">    istio:</span> <span class="string">ingressgateway</span> <span class="comment"># use Istio default gateway implementation</span></span><br><span class="line"><span class="attr">  servers:</span></span><br><span class="line"><span class="attr">  - port:</span></span><br><span class="line"><span class="attr">      number:</span> <span class="number">80</span></span><br><span class="line"><span class="attr">      name:</span> <span class="string">http</span></span><br><span class="line"><span class="attr">      protocol:</span> <span class="string">HTTP</span></span><br><span class="line"><span class="attr">    hosts:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">"httpbin.example.com"</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># configure routes for the gateway</span></span><br><span class="line"><span class="string">cat</span> <span class="string">&lt;&lt;EOF</span> <span class="string">| istioctl create -f -</span></span><br><span class="line"><span class="string"></span><span class="attr">apiVersion:</span> <span class="string">networking.istio.io/v1alpha3</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">VirtualService</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">httpbin</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  hosts:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">"httpbin.example.com"</span></span><br><span class="line"><span class="attr">  gateways:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">httpbin-gateway</span></span><br><span class="line"><span class="attr">  http:</span></span><br><span class="line"><span class="attr">  - match:</span></span><br><span class="line"><span class="attr">    - uri:</span></span><br><span class="line"><span class="attr">        prefix:</span> <span class="string">/status</span></span><br><span class="line"><span class="attr">    - uri:</span></span><br><span class="line"><span class="attr">        prefix:</span> <span class="string">/delay</span></span><br><span class="line"><span class="attr">    route:</span></span><br><span class="line"><span class="attr">    - destination:</span></span><br><span class="line"><span class="attr">        port:</span></span><br><span class="line"><span class="attr">          number:</span> <span class="number">8000</span></span><br><span class="line"><span class="attr">        host:</span> <span class="string">httpbin</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># validate 200</span></span><br><span class="line"><span class="string">curl</span> <span class="bullet">--resolve</span> <span class="string">httpbin.example.com:$INGRESS_PORT:$INGRESS_HOST</span> <span class="attr">-HHost:httpbin.example.com</span> <span class="bullet">-I</span> <span class="attr">http://httpbin.example.com:$INGRESS_PORT/status/200</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># invalidate 404</span></span><br><span class="line"><span class="string">curl</span> <span class="bullet">--resolve</span> <span class="string">httpbin.example.com:$INGRESS_PORT:$INGRESS_HOST</span> <span class="attr">-HHost:httpbin.example.com</span> <span class="bullet">-I</span> <span class="attr">http://httpbin.example.com:$INGRESS_PORT/headers</span></span><br></pre></td></tr></table></figure></p><p>使用 TLS：<br><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 生成证书</span></span><br><span class="line"><span class="string">git</span> <span class="string">clone</span> <span class="attr">https://github.com/nicholasjackson/mtls-go-example</span></span><br><span class="line"></span><br><span class="line"><span class="string">cd</span> <span class="string">mtls-go-example</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#该命令将产生四个目录：1_root，2_intermediate，3_application和4_client与你将使用客户端和服务器证书。</span></span><br><span class="line"><span class="string">generate.sh</span> <span class="string">bookinfo.example.com</span> <span class="string">&lt;password&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># istio-ingressgateway-certs必须在istio-system命名空间中</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">create</span> <span class="bullet">-n</span> <span class="string">istio-system</span> <span class="string">secret</span> <span class="string">tls</span> <span class="string">istio-ingressgateway-certs</span> <span class="bullet">--key</span> <span class="number">3</span><span class="string">_application/private/httpbin.example.com.key.pem</span> <span class="bullet">--cert</span> <span class="number">3</span><span class="string">_application/certs/httpbin.example.com.cert.pem</span></span><br><span class="line"></span><br><span class="line"><span class="string">cat</span> <span class="string">&lt;&lt;EOF</span> <span class="string">| istioctl replace -f -</span></span><br><span class="line"><span class="string"></span><span class="attr">apiVersion:</span> <span class="string">networking.istio.io/v1alpha3</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Gateway</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">httpbin-gateway</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  selector:</span></span><br><span class="line"><span class="attr">    istio:</span> <span class="string">ingressgateway</span> <span class="comment"># use istio default ingress gateway</span></span><br><span class="line"><span class="attr">  servers:</span></span><br><span class="line"><span class="attr">  - port:</span></span><br><span class="line"><span class="attr">      number:</span> <span class="number">80</span></span><br><span class="line"><span class="attr">      name:</span> <span class="string">http</span></span><br><span class="line"><span class="attr">      protocol:</span> <span class="string">HTTP</span></span><br><span class="line"><span class="attr">    hosts:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">"httpbin.example.com"</span></span><br><span class="line"><span class="attr">  - port:</span></span><br><span class="line"><span class="attr">      number:</span> <span class="number">443</span></span><br><span class="line"><span class="attr">      name:</span> <span class="string">https</span></span><br><span class="line"><span class="attr">      protocol:</span> <span class="string">HTTPS</span></span><br><span class="line"><span class="attr">    tls:</span></span><br><span class="line"><span class="attr">      mode:</span> <span class="string">SIMPLE</span></span><br><span class="line"><span class="attr">      serverCertificate:</span> <span class="string">/etc/istio/ingressgateway-certs/tls.crt</span></span><br><span class="line"><span class="attr">      privateKey:</span> <span class="string">/etc/istio/ingressgateway-certs/tls.key</span></span><br><span class="line"><span class="attr">    hosts:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">"httpbin.example.com"</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># validate 200</span></span><br><span class="line"><span class="string">curl</span> <span class="bullet">--resolve</span> <span class="string">httpbin.example.com:$SECURE_INGRESS_PORT:$INGRESS_HOST</span> <span class="attr">-HHost:httpbin.example.com</span> <span class="bullet">-I</span> <span class="bullet">-k</span> <span class="attr">https://httpbin.example.com:$SECURE_INGRESS_PORT/status/200</span></span><br></pre></td></tr></table></figure></p><h1 id="Egress-流量"><a href="#Egress-流量" class="headerlink" title="Egress 流量"></a>Egress 流量</h1><p>默认情况下，Istio 接管了容器的内外网流量，从容器内部无法访问 Kubernetes 集群外的服务。可以通过 ServiceEntry 为需要的容器开放 Egress 访问，如<br><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="string">$</span> <span class="string">cat</span> <span class="string">&lt;&lt;EOF</span> <span class="string">| istioctl create -f -</span></span><br><span class="line"><span class="string"></span><span class="attr">apiVersion:</span> <span class="string">networking.istio.io/v1alpha3</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ServiceEntry</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">httpbin-ext</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  hosts:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">httpbin.org</span></span><br><span class="line"><span class="attr">  ports:</span></span><br><span class="line"><span class="attr">  - number:</span> <span class="number">80</span></span><br><span class="line"><span class="attr">    name:</span> <span class="string">http</span></span><br><span class="line"><span class="attr">    protocol:</span> <span class="string">HTTP</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line"><span class="string">$</span> <span class="string">cat</span> <span class="string">&lt;&lt;EOF</span> <span class="string">| istioctl create -f -</span></span><br><span class="line"><span class="string"></span><span class="attr">apiVersion:</span> <span class="string">networking.istio.io/v1alpha3</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">VirtualService</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">httpbin-ext</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  hosts:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">httpbin.org</span></span><br><span class="line"><span class="attr">  http:</span></span><br><span class="line"><span class="attr">  - timeout:</span> <span class="number">3</span><span class="string">s</span></span><br><span class="line"><span class="attr">    route:</span></span><br><span class="line"><span class="attr">      - destination:</span></span><br><span class="line"><span class="attr">          host:</span> <span class="string">httpbin.org</span></span><br><span class="line"><span class="attr">        weight:</span> <span class="number">100</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure></p><p>需要注意的是 ServiceEntry 仅支持 HTTP、TCP 和 HTTPS，对于其他协议需要通过 –includeIPRanges 的方式设置 IP 地址范围，如<br><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">helm template @install/kubernetes/helm/istio@ --name istio --namespace istio-system --set global.proxy.includeIPRanges="10.0.0.1/24" -x @templates/sidecar-injector-configmap.yaml@ | kubectl apply -f -</span><br></pre></td></tr></table></figure></p><h1 id="流量镜像"><a href="#流量镜像" class="headerlink" title="流量镜像"></a>流量镜像</h1><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="string">cat</span> <span class="string">&lt;&lt;EOF</span> <span class="string">| istioctl replace -f -</span></span><br><span class="line"><span class="string"></span><span class="attr">apiVersion:</span> <span class="string">networking.istio.io/v1alpha3</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">VirtualService</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">httpbin</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  hosts:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">httpbin</span></span><br><span class="line"><span class="attr">  http:</span></span><br><span class="line"><span class="attr">  - route:</span></span><br><span class="line"><span class="attr">    - destination:</span></span><br><span class="line"><span class="attr">        host:</span> <span class="string">httpbin</span></span><br><span class="line"><span class="attr">        subset:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">      weight:</span> <span class="number">100</span></span><br><span class="line"><span class="attr">    mirror:</span></span><br><span class="line"><span class="attr">      host:</span> <span class="string">httpbin</span></span><br><span class="line"><span class="attr">      subset:</span> <span class="string">v2</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure><h1 id="参考文档"><a href="#参考文档" class="headerlink" title="参考文档"></a>参考文档</h1><p><a href="https://istio.io/docs/tasks/traffic-management/" target="_blank" rel="noopener">istio官方文档</a><br><a href="https://kubernetes.feisky.xyz/zh/apps/istio-traffic-management.html" target="_blank" rel="noopener">istio流量管理</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;Istio-流量管理&quot;&gt;&lt;a href=&quot;#Istio-流量管理&quot; class=&quot;headerlink&quot; title=&quot;Istio 流量管理&quot;&gt;&lt;/a&gt;Istio 流量管理&lt;/h1&gt;&lt;p&gt;Istio 提供了强大的流量管理功能，如智能路由、服务发现与负载均衡、故障恢
      
    
    </summary>
    
      <category term="DevOps" scheme="https://www.zhengyuyan.com/categories/DevOps/"/>
    
    
      <category term="service Mesh" scheme="https://www.zhengyuyan.com/tags/service-Mesh/"/>
    
  </entry>
  
  <entry>
    <title>istio官方示例bookinfo</title>
    <link href="https://www.zhengyuyan.com/201807/17/bookinfo/"/>
    <id>https://www.zhengyuyan.com/201807/17/bookinfo/</id>
    <published>2018-07-17T13:38:19.000Z</published>
    <updated>2018-07-17T13:58:25.726Z</updated>
    
    <content type="html"><![CDATA[<h1 id="官方bookinfo示例"><a href="#官方bookinfo示例" class="headerlink" title="官方bookinfo示例"></a>官方bookinfo示例</h1><p>bookinfo显示有关书籍的信息，类似于在线书店的单个商品。页面上显示的是书籍，书籍详细信息（ISBN，页数等）以及一些书评。</p><p>Bookinfo应用程序分为四个独立的微服务：</p><ul><li>productpage。productpage微服务调用详细信息并查看微服务以填充页面。</li><li>details。details微服务包含书籍信息。</li><li>reviews。reviews微服务包含书评。它还称为评级微服务。</li><li>ratings。ratings微服务包含伴随书评的书籍排名信息。</li></ul><p>reviews微服务有3个版本：</p><ul><li>版本v1不会调用评级服务。</li><li>版本v2调用评级服务，并将每个评级显示为1到5个黑色星。</li><li>版本v3调用评级服务，并将每个评级显示为1到5个红星。</li></ul><p>应用程序的端到端架构如下所示。<br><figure class="image-bubble">                <div class="img-lightbox">                    <div class="overlay"></div>                    <img src="./images/noistio.png" alt="" title="">                </div>                <div class="image-caption"></div>            </figure></p><h2 id="部署应用程序"><a href="#部署应用程序" class="headerlink" title="部署应用程序"></a>部署应用程序</h2><p>使用Istio不需要更改应用程序本身。相反，我们只需要在启用Istio的环境中配置和运行服务，并在每个服务旁边注入Envoy边车。所需的命令和配置因运行时环境而异，但在所有情况下，生成的部署将如下所示：<br><figure class="image-bubble">                <div class="img-lightbox">                    <div class="overlay"></div>                    <img src="/img/withistio.png" alt="" title="">                </div>                <div class="image-caption"></div>            </figure></p><ul><li>创建istio-app命名空间<code>kubectl create namespace istio-app</code></li><li>将<code>istio-app</code>命名空间设置为自动注入标签<code>kubectl label namespace istio-app istio-injection=enabled</code></li><li>执行<code>kubectl apply -f samples/bookinfo/kube/bookinfo.yaml</code><figure class="image-bubble">                <div class="img-lightbox">                    <div class="overlay"></div>                    <img src="/img/istio-app.png" alt="" title="">                </div>                <div class="image-caption"></div>            </figure>部署好的productpage会自动注入sideCar<figure class="image-bubble">                <div class="img-lightbox">                    <div class="overlay"></div>                    <img src="/img/productpage.png" alt="" title="">                </div>                <div class="image-caption"></div>            </figure></li><li><p>为程序定义网关入口<code>istioctl create -f gateway/gateway.yaml -n istio-app</code></p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.istio.io/v1alpha3</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Gateway</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">istio-gateway</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  selector:</span></span><br><span class="line"><span class="attr">    istio:</span> <span class="string">ingressgateway</span> <span class="comment"># use istio default controller</span></span><br><span class="line"><span class="attr">  servers:</span></span><br><span class="line"><span class="attr">  - port:</span></span><br><span class="line"><span class="attr">      number:</span> <span class="number">80</span></span><br><span class="line"><span class="attr">      name:</span> <span class="string">http</span></span><br><span class="line"><span class="attr">      protocol:</span> <span class="string">HTTP</span></span><br><span class="line"><span class="attr">    hosts:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">"bookinfo.example.com"</span></span><br></pre></td></tr></table></figure></li><li><p>创建VirtualService</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.istio.io/v1alpha3</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">VirtualService</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">bookinfo</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  hosts:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">"bookinfo.example.com"</span></span><br><span class="line"><span class="attr">  gateways:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">istio-gateway</span></span><br><span class="line"><span class="attr">  http:</span></span><br><span class="line"><span class="attr">  - match:</span></span><br><span class="line"><span class="attr">    - uri:</span></span><br><span class="line"><span class="attr">        exact:</span> <span class="string">/productpage</span></span><br><span class="line"><span class="attr">    - uri:</span></span><br><span class="line"><span class="attr">        exact:</span> <span class="string">/login</span></span><br><span class="line"><span class="attr">    - uri:</span></span><br><span class="line"><span class="attr">        exact:</span> <span class="string">/logout</span></span><br><span class="line"><span class="attr">    - uri:</span></span><br><span class="line"><span class="attr">        prefix:</span> <span class="string">/api/v1/products</span></span><br><span class="line"><span class="attr">    route:</span></span><br><span class="line"><span class="attr">    - destination:</span></span><br><span class="line"><span class="attr">        host:</span> <span class="string">productpage.istio-app.svc.cluster.local</span></span><br><span class="line"><span class="attr">        port:</span></span><br><span class="line"><span class="attr">          number:</span> <span class="number">9080</span></span><br></pre></td></tr></table></figure></li></ul><h1 id="参考文档"><a href="#参考文档" class="headerlink" title="参考文档"></a>参考文档</h1><p><a href="https://istio.io/docs/guides/bookinfo/" target="_blank" rel="noopener">isito官方示例</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;官方bookinfo示例&quot;&gt;&lt;a href=&quot;#官方bookinfo示例&quot; class=&quot;headerlink&quot; title=&quot;官方bookinfo示例&quot;&gt;&lt;/a&gt;官方bookinfo示例&lt;/h1&gt;&lt;p&gt;bookinfo显示有关书籍的信息，类似于在线书店的单个商品
      
    
    </summary>
    
      <category term="DevOps" scheme="https://www.zhengyuyan.com/categories/DevOps/"/>
    
    
      <category term="service Mesh" scheme="https://www.zhengyuyan.com/tags/service-Mesh/"/>
    
  </entry>
  
  <entry>
    <title>istio 安装(二)</title>
    <link href="https://www.zhengyuyan.com/201807/17/istio-install/"/>
    <id>https://www.zhengyuyan.com/201807/17/istio-install/</id>
    <published>2018-07-17T13:28:42.000Z</published>
    <updated>2018-07-17T13:58:19.690Z</updated>
    
    <content type="html"><![CDATA[<h1 id="istio安装"><a href="#istio安装" class="headerlink" title="istio安装"></a>istio安装</h1><p><a href="https://istio.io/docs/setup/" target="_blank" rel="noopener">istio官网安装</a>提供了多种方法，因为集群中包含helm，所以选择用helm安装istio</p><ul><li><a href="https://github.com/istio/istio/releases" target="_blank" rel="noopener">下载</a>istio release(目前版本为0.8.0)</li><li>命令行执行<code>helm install install/kubernetes/helm/istio --name istio --namespace istio-system</code>(此命令采取自动注入sideCar)</li></ul><p>istio的helm的value.yaml文件如下:<br><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># Use --set or additional values.yaml file to configure settings.</span></span><br><span class="line"><span class="comment"># This file no longer uses sed, updateVersions.sh or istio.VERSIONS</span></span><br><span class="line"><span class="comment"># <span class="doctag">TODO:</span> evaluate if we need individual overrides for each component version, istio</span></span><br><span class="line"><span class="comment"># is not typically tested with a mix of versions. Only supported case is version upgrade.</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Common settings.</span></span><br><span class="line"><span class="attr">global:</span></span><br><span class="line">  <span class="comment"># Default repository for Istio images.</span></span><br><span class="line">  <span class="comment"># Releases are published to docker hub under 'istio' project.</span></span><br><span class="line">  <span class="comment"># Daily builds from prow are on gcr.io, and nightly builds from circle on</span></span><br><span class="line">  <span class="comment"># docker.io/istionightly</span></span><br><span class="line"><span class="attr">  hub:</span> <span class="number">192.168</span><span class="number">.30</span><span class="number">.100</span><span class="string">:8889/istio</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># Default tag for Istio images.</span></span><br><span class="line">  <span class="comment"># Should track latest released version in the branch.</span></span><br><span class="line"><span class="attr">  tag:</span> <span class="number">0.8</span><span class="number">.0</span></span><br><span class="line"><span class="attr">  proxy:</span></span><br><span class="line"><span class="attr">    image:</span> <span class="string">proxyv2</span></span><br><span class="line"><span class="attr">    resources:</span></span><br><span class="line"><span class="attr">      requests:</span></span><br><span class="line"><span class="attr">        cpu:</span> <span class="number">100</span><span class="string">m</span></span><br><span class="line"><span class="attr">        memory:</span> <span class="number">128</span><span class="string">Mi</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># istio-sidecar-injector configmap stores configuration for sidecar injection.</span></span><br><span class="line">    <span class="comment"># This config map is used by istioctl kube-inject and the injector webhook.</span></span><br><span class="line"><span class="attr">    enableCoreDump:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">    serviceAccountName:</span> <span class="string">default</span> <span class="comment"># used only if RBAC is not enabled</span></span><br><span class="line"><span class="attr">    replicaCount:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">    resources:</span></span><br><span class="line"><span class="attr">      requests:</span></span><br><span class="line"><span class="attr">        cpu:</span> <span class="number">100</span><span class="string">m</span></span><br><span class="line"><span class="attr">        memory:</span> <span class="number">128</span><span class="string">Mi</span></span><br><span class="line">    <span class="comment"># limits:</span></span><br><span class="line">    <span class="comment">#  cpu: 100m</span></span><br><span class="line">    <span class="comment">#  memory: 128Mi</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># istio egress capture whitelist</span></span><br><span class="line">    <span class="comment"># https://istio.io/docs/tasks/traffic-management/egress.html#calling-external-services-directly</span></span><br><span class="line">    <span class="comment"># example: includeIPRanges: "172.30.0.0/16,172.20.0.0/16"</span></span><br><span class="line">    <span class="comment"># would only capture egress traffic on those two IP Ranges, all other outbound traffic would</span></span><br><span class="line">    <span class="comment"># be allowed by the sidecar</span></span><br><span class="line"><span class="attr">    includeIPRanges:</span> <span class="string">"*"</span></span><br><span class="line"><span class="attr">    excludeIPRanges:</span> <span class="string">""</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># istio ingress capture whitelist</span></span><br><span class="line">    <span class="comment"># examples:</span></span><br><span class="line">    <span class="comment">#     Redirect no inbound traffic to Envoy:    --includeInboundPorts=""</span></span><br><span class="line">    <span class="comment">#     Redirect all inbound traffic to Envoy:   --includeInboundPorts="*"</span></span><br><span class="line">    <span class="comment">#     Redirect only selected ports:            --includeInboundPorts="80,8080"</span></span><br><span class="line"><span class="attr">    includeInboundPorts:</span> <span class="string">"*"</span></span><br><span class="line"><span class="attr">    excludeInboundPorts:</span> <span class="string">""</span></span><br><span class="line"><span class="attr">    policy:</span> <span class="string">enabled</span></span><br><span class="line"></span><br><span class="line"><span class="attr">  proxy_init:</span></span><br><span class="line"><span class="attr">    image:</span> <span class="string">proxy_init</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># imagePullPolicy is applied to istio control plane components.</span></span><br><span class="line">  <span class="comment"># local tests require IfNotPresent, to avoid uploading to dockerhub.</span></span><br><span class="line">  <span class="comment"># <span class="doctag">TODO:</span> Switch to Always as default, and override in the local tests.</span></span><br><span class="line"><span class="attr">  imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># Not recommended for user to configure this. Hyperkube image to use when creating custom resources</span></span><br><span class="line"><span class="attr">  hyperkube:</span></span><br><span class="line"><span class="attr">    repository:</span> <span class="number">192.168</span><span class="number">.30</span><span class="number">.100</span><span class="string">:8889/coreos/hyperkube</span></span><br><span class="line"><span class="attr">    tag:</span> <span class="string">v1.7.6_coreos.0</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># controlPlaneMtls enabled. Will result in delays starting the pods while secrets are</span></span><br><span class="line">  <span class="comment"># propagated, not recommended for tests.</span></span><br><span class="line"><span class="attr">  controlPlaneSecurityEnabled:</span> <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># Default mtls policy. If true, mtls between services will be enabled by default.</span></span><br><span class="line"><span class="attr">  mtls:</span></span><br><span class="line">    <span class="comment"># Default setting for service-to-service mtls. Can be set explicitly using</span></span><br><span class="line">    <span class="comment"># destination rules or service annotations.</span></span><br><span class="line"><span class="attr">    enabled:</span> <span class="literal">false</span></span><br><span class="line">    <span class="comment"># List of fully qualified services to exclude from mtls</span></span><br><span class="line">    <span class="comment"># <span class="doctag">TODO:</span> add the templating.</span></span><br><span class="line"><span class="attr">    mtlsExcludedServices:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">"kubernetes.default.svc.cluster.local"</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># create RBAC resources. Must be set for any cluster configured with rbac.</span></span><br><span class="line"><span class="attr">  rbacEnabled:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">## imagePullSecrets for all ServiceAccount. Must be set for any clustser configured with privte docker registry.</span></span><br><span class="line">  <span class="comment"># imagePullSecrets:</span></span><br><span class="line">  <span class="comment">#   - name: "private-registry-key"</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># Default is 1 second</span></span><br><span class="line"><span class="attr">  refreshInterval:</span> <span class="number">10</span><span class="string">s</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># Enable multicluster operation.  Must be set to true if multicluster operation</span></span><br><span class="line">  <span class="comment"># is desired.</span></span><br><span class="line"><span class="attr">  multicluster:</span></span><br><span class="line"><span class="attr">    enabled:</span> <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># Specify pod scheduling arch(amd64, ppc64le, s390x) and weight as follows:</span></span><br><span class="line">  <span class="comment">#   0 - Never scheduled</span></span><br><span class="line">  <span class="comment">#   1 - Least preferred</span></span><br><span class="line">  <span class="comment">#   2 - No preference</span></span><br><span class="line">  <span class="comment">#   3 - Most preferred</span></span><br><span class="line"><span class="attr">  arch:</span></span><br><span class="line"><span class="attr">    amd64:</span> <span class="number">2</span></span><br><span class="line"><span class="attr">    s390x:</span> <span class="number">2</span></span><br><span class="line"><span class="attr">    ppc64le:</span> <span class="number">2</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Any customization for istio testing should be here</span></span><br><span class="line"><span class="attr">istiotesting:</span></span><br><span class="line"><span class="attr">  oneNameSpace:</span> <span class="literal">false</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># ingress configuration</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="attr">ingress:</span></span><br><span class="line"><span class="attr">  enabled:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">  serviceAccountName:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">  autoscaleMin:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">  autoscaleMax:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">  resources:</span> <span class="string">&#123;&#125;</span></span><br><span class="line"><span class="comment"># limits:</span></span><br><span class="line"><span class="comment">#  cpu: 100m</span></span><br><span class="line"><span class="comment">#  memory: 128Mi</span></span><br><span class="line"><span class="comment"># requests:</span></span><br><span class="line"><span class="comment">#  cpu: 100m</span></span><br><span class="line"><span class="comment">#  memory: 128Mi</span></span><br><span class="line"><span class="attr">  service:</span></span><br><span class="line"><span class="attr">    loadBalancerIP:</span> <span class="string">"10.100.100.20"</span></span><br><span class="line"><span class="attr">    type:</span> <span class="string">LoadBalancer</span> <span class="comment">#change to NodePort, ClusterIP or LoadBalancer if need be</span></span><br><span class="line"><span class="attr">    ports:</span></span><br><span class="line"><span class="attr">    - port:</span> <span class="number">80</span></span><br><span class="line"><span class="attr">      name:</span> <span class="string">http</span></span><br><span class="line"><span class="attr">      nodePort:</span> <span class="number">32000</span></span><br><span class="line"><span class="attr">    - port:</span> <span class="number">443</span></span><br><span class="line"><span class="attr">      name:</span> <span class="string">https</span></span><br><span class="line"><span class="attr">    selector:</span></span><br><span class="line"><span class="attr">      istio:</span> <span class="string">ingress</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># ingressgateway configuration</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="attr">ingressgateway:</span></span><br><span class="line"><span class="attr">  enabled:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">  serviceAccountName:</span> <span class="string">istio-ingressgateway-service-account</span></span><br><span class="line"><span class="attr">  autoscaleMin:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">  autoscaleMax:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">  resources:</span> <span class="string">&#123;&#125;</span></span><br><span class="line"><span class="comment"># limits:</span></span><br><span class="line"><span class="comment">#  cpu: 100m</span></span><br><span class="line"><span class="comment">#  memory: 128Mi</span></span><br><span class="line"><span class="comment"># requests:</span></span><br><span class="line"><span class="comment">#  cpu: 100m</span></span><br><span class="line"><span class="comment">#  memory: 128Mi</span></span><br><span class="line"><span class="attr">  service:</span></span><br><span class="line"><span class="attr">    name:</span> <span class="string">istio-ingressgateway</span> <span class="comment">#DNS addressible</span></span><br><span class="line"><span class="attr">    labels:</span></span><br><span class="line"><span class="attr">      istio:</span> <span class="string">ingressgateway</span></span><br><span class="line">    <span class="comment">#namespace: istio-system</span></span><br><span class="line"><span class="attr">    loadBalancerIP:</span> <span class="string">"10.100.100.129"</span></span><br><span class="line"><span class="attr">    type:</span> <span class="string">LoadBalancer</span> <span class="comment">#change to NodePort, ClusterIP or LoadBalancer if need be</span></span><br><span class="line"><span class="attr">    ports:</span></span><br><span class="line">      <span class="comment">## You can add custom gateway ports</span></span><br><span class="line"><span class="attr">    - port:</span> <span class="number">80</span></span><br><span class="line"><span class="attr">      name:</span> <span class="string">http</span></span><br><span class="line"><span class="attr">      nodePort:</span> <span class="number">31380</span></span><br><span class="line"><span class="attr">    - port:</span> <span class="number">443</span></span><br><span class="line"><span class="attr">      name:</span> <span class="string">https</span></span><br><span class="line"><span class="attr">      nodePort:</span> <span class="number">31390</span></span><br><span class="line"><span class="attr">    - port:</span> <span class="number">31400</span></span><br><span class="line"><span class="attr">      name:</span> <span class="string">tcp</span></span><br><span class="line"><span class="attr">      nodePort:</span> <span class="number">31400</span></span><br><span class="line"><span class="attr">  deployment:</span></span><br><span class="line"><span class="attr">    labels:</span></span><br><span class="line"><span class="attr">      istio:</span> <span class="string">ingressgateway</span> <span class="comment">#will be added to pods and service</span></span><br><span class="line"><span class="attr">    ports:</span></span><br><span class="line"><span class="attr">    - containerPort:</span> <span class="number">80</span></span><br><span class="line"><span class="attr">    - containerPort:</span> <span class="number">443</span></span><br><span class="line"><span class="attr">    - containerPort:</span> <span class="number">31400</span></span><br><span class="line"><span class="attr">    secretVolumes:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">ingressgateway-certs</span></span><br><span class="line"><span class="attr">      secretName:</span> <span class="string">istio-ingressgateway-certs</span></span><br><span class="line"><span class="attr">      mountPath:</span> <span class="string">/etc/istio/ingressgateway-certs</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># egressgateway configuration</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="attr">egressgateway:</span></span><br><span class="line"><span class="attr">  enabled:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">  serviceAccountName:</span> <span class="string">istio-egressgateway-service-account</span></span><br><span class="line"><span class="attr">  autoscaleMin:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">  autoscaleMax:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">  resources:</span> <span class="string">&#123;&#125;</span></span><br><span class="line"><span class="comment"># limits:</span></span><br><span class="line"><span class="comment">#  cpu: 100m</span></span><br><span class="line"><span class="comment">#  memory: 128Mi</span></span><br><span class="line"><span class="comment"># requests:</span></span><br><span class="line"><span class="comment">#  cpu: 100m</span></span><br><span class="line"><span class="comment">#  memory: 128Mi</span></span><br><span class="line"><span class="attr">  service:</span></span><br><span class="line"><span class="attr">    name:</span> <span class="string">istio-egressgateway</span> <span class="comment">#DNS addressible</span></span><br><span class="line"><span class="attr">    labels:</span></span><br><span class="line"><span class="attr">      istio:</span> <span class="string">egressgateway</span></span><br><span class="line">    <span class="comment">#namespace: istio-system</span></span><br><span class="line"><span class="attr">    type:</span> <span class="string">ClusterIP</span> <span class="comment">#change to NodePort or LoadBalancer if need be</span></span><br><span class="line"><span class="attr">    ports:</span></span><br><span class="line">      <span class="comment">## You can add custom gateway ports</span></span><br><span class="line"><span class="attr">    - port:</span> <span class="number">80</span></span><br><span class="line"><span class="attr">      name:</span> <span class="string">http</span></span><br><span class="line"><span class="attr">    - port:</span> <span class="number">443</span></span><br><span class="line"><span class="attr">      name:</span> <span class="string">https</span></span><br><span class="line"><span class="attr">  deployment:</span></span><br><span class="line"><span class="attr">    labels:</span></span><br><span class="line"><span class="attr">      istio:</span> <span class="string">egressgateway</span> <span class="comment">#will be added to pods and service</span></span><br><span class="line"><span class="attr">    ports:</span></span><br><span class="line"><span class="attr">    - containerPort:</span> <span class="number">80</span></span><br><span class="line"><span class="attr">    - containerPort:</span> <span class="number">443</span></span><br><span class="line">  <span class="comment"># secretVolumes: TODO</span></span><br><span class="line">  <span class="comment"># - name: someName</span></span><br><span class="line">  <span class="comment">#   mountPath: somePath</span></span><br><span class="line">  <span class="comment">#   secretName: someName</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># sidecar-injector webhook configuration</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="attr">sidecarInjectorWebhook:</span></span><br><span class="line"><span class="attr">  enabled:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">  image:</span> <span class="string">sidecar_injector</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># galley configuration</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="attr">galley:</span></span><br><span class="line"><span class="attr">  enabled:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">  serviceAccountName:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">  replicaCount:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">  image:</span> <span class="string">galley</span></span><br><span class="line"><span class="attr">  resources:</span> <span class="string">&#123;&#125;</span></span><br><span class="line">  <span class="comment"># limits:</span></span><br><span class="line">  <span class="comment">#  cpu: 100m</span></span><br><span class="line">  <span class="comment">#  memory: 128Mi</span></span><br><span class="line">  <span class="comment"># requests:</span></span><br><span class="line">  <span class="comment">#  cpu: 100m</span></span><br><span class="line">  <span class="comment">#  memory: 128Mi</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># mixer configuration</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="attr">mixer:</span></span><br><span class="line"><span class="attr">  enabled:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">  serviceAccountName:</span> <span class="string">default</span> <span class="comment"># used only if RBAC is not enabled</span></span><br><span class="line"><span class="attr">  replicaCount:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">  image:</span> <span class="string">mixer</span></span><br><span class="line"><span class="attr">  resources:</span> <span class="string">&#123;&#125;</span></span><br><span class="line">  <span class="comment"># limits:</span></span><br><span class="line">  <span class="comment">#  cpu: 100m</span></span><br><span class="line">  <span class="comment">#  memory: 128Mi</span></span><br><span class="line">  <span class="comment"># requests:</span></span><br><span class="line">  <span class="comment">#  cpu: 100m</span></span><br><span class="line">  <span class="comment">#  memory: 128Mi</span></span><br><span class="line"></span><br><span class="line"><span class="attr">  prometheusStatsdExporter:</span></span><br><span class="line"><span class="attr">    repository:</span> <span class="number">192.168</span><span class="number">.30</span><span class="number">.100</span><span class="string">:8889/prom/statsd-exporter</span></span><br><span class="line"><span class="attr">    tag:</span> <span class="string">latest</span></span><br><span class="line"><span class="attr">    resources:</span> <span class="string">&#123;&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># pilot configuration</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="attr">pilot:</span></span><br><span class="line"><span class="attr">  enabled:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">  serviceAccountName:</span> <span class="string">default</span> <span class="comment"># used only if RBAC is not enabled</span></span><br><span class="line"><span class="attr">  replicaCount:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">  image:</span> <span class="string">pilot</span></span><br><span class="line"><span class="attr">  resources:</span> <span class="string">&#123;&#125;</span></span><br><span class="line">  <span class="comment"># limits:</span></span><br><span class="line">  <span class="comment">#  cpu: 100m</span></span><br><span class="line">  <span class="comment">#  memory: 128Mi</span></span><br><span class="line">  <span class="comment"># requests:</span></span><br><span class="line">  <span class="comment">#  cpu: 100m</span></span><br><span class="line">  <span class="comment">#  memory: 128Mi</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># security configuration</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="attr">security:</span></span><br><span class="line"><span class="attr">  enabled:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">  serviceAccountName:</span> <span class="string">default</span> <span class="comment"># used only if RBAC is not enabled</span></span><br><span class="line"><span class="attr">  replicaCount:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">  image:</span> <span class="string">citadel</span></span><br><span class="line"><span class="attr">  resources:</span> <span class="string">&#123;&#125;</span></span><br><span class="line">  <span class="comment"># limits:</span></span><br><span class="line">  <span class="comment">#  cpu: 100m</span></span><br><span class="line">  <span class="comment">#  memory: 128Mi</span></span><br><span class="line">  <span class="comment"># requests:</span></span><br><span class="line">  <span class="comment">#  cpu: 100m</span></span><br><span class="line">  <span class="comment">#  memory: 128Mi</span></span><br><span class="line"><span class="attr">  cleanUpOldCA:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># addons configuration</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="attr">grafana:</span></span><br><span class="line"><span class="attr">  enabled:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">  replicaCount:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">  image:</span> <span class="string">grafana</span></span><br><span class="line"><span class="attr">  service:</span></span><br><span class="line"><span class="attr">    name:</span> <span class="string">http</span></span><br><span class="line"><span class="attr">    type:</span> <span class="string">ClusterIP</span></span><br><span class="line"><span class="attr">    externalPort:</span> <span class="number">3000</span></span><br><span class="line"><span class="attr">    internalPort:</span> <span class="number">3000</span></span><br><span class="line"><span class="attr">  ingress:</span></span><br><span class="line"><span class="attr">    enabled:</span> <span class="literal">false</span></span><br><span class="line">    <span class="comment"># Used to create an Ingress record.</span></span><br><span class="line"><span class="attr">    hosts:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">grafana.local</span></span><br><span class="line"><span class="attr">    annotations:</span></span><br><span class="line">      <span class="comment"># kubernetes.io/ingress.class: nginx</span></span><br><span class="line">      <span class="comment"># kubernetes.io/tls-acme: "true"</span></span><br><span class="line"><span class="attr">    tls:</span></span><br><span class="line">      <span class="comment"># Secrets must be manually created in the namespace.</span></span><br><span class="line">      <span class="comment"># - secretName: grafana-tls</span></span><br><span class="line">      <span class="comment">#   hosts:</span></span><br><span class="line">      <span class="comment">#     - grafana.local</span></span><br><span class="line"></span><br><span class="line"><span class="attr">  resources:</span> <span class="string">&#123;&#125;</span></span><br><span class="line">    <span class="comment"># limits:</span></span><br><span class="line">    <span class="comment">#  cpu: 100m</span></span><br><span class="line">    <span class="comment">#  memory: 128Mi</span></span><br><span class="line">    <span class="comment"># requests:</span></span><br><span class="line">    <span class="comment">#  cpu: 100m</span></span><br><span class="line">    <span class="comment">#  memory: 128Mi</span></span><br><span class="line"></span><br><span class="line"><span class="attr">prometheus:</span></span><br><span class="line"><span class="attr">  enabled:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">  replicaCount:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">  image:</span></span><br><span class="line"><span class="attr">    repository:</span> <span class="number">192.168</span><span class="number">.30</span><span class="number">.100</span><span class="string">:8889/prom/prometheus</span></span><br><span class="line"><span class="attr">    tag:</span> <span class="string">latest</span></span><br><span class="line"><span class="attr">  ingress:</span></span><br><span class="line"><span class="attr">    enabled:</span> <span class="literal">false</span></span><br><span class="line">    <span class="comment"># Used to create an Ingress record.</span></span><br><span class="line">    <span class="comment">#hosts:</span></span><br><span class="line">    <span class="comment">#  - prometheus.local</span></span><br><span class="line"><span class="attr">    annotations:</span></span><br><span class="line">      <span class="comment"># kubernetes.io/ingress.class: nginx</span></span><br><span class="line">      <span class="comment"># kubernetes.io/tls-acme: "true"</span></span><br><span class="line"><span class="attr">    tls:</span></span><br><span class="line">      <span class="comment"># Secrets must be manually created in the namespace.</span></span><br><span class="line">      <span class="comment"># - secretName: prometheus-tls</span></span><br><span class="line">      <span class="comment">#   hosts:</span></span><br><span class="line">      <span class="comment">#     - prometheus.local</span></span><br><span class="line"><span class="attr">  resources:</span> <span class="string">&#123;&#125;</span></span><br><span class="line">    <span class="comment"># limits:</span></span><br><span class="line">    <span class="comment">#  cpu: 100m</span></span><br><span class="line">    <span class="comment">#  memory: 128Mi</span></span><br><span class="line">    <span class="comment"># requests:</span></span><br><span class="line">    <span class="comment">#  cpu: 100m</span></span><br><span class="line">    <span class="comment">#  memory: 128Mi</span></span><br><span class="line"><span class="attr">  service:</span></span><br><span class="line"><span class="attr">    nodePort:</span></span><br><span class="line"><span class="attr">      enabled:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">      port:</span> <span class="number">32090</span></span><br><span class="line"></span><br><span class="line"><span class="attr">servicegraph:</span></span><br><span class="line"><span class="attr">  enabled:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">  replicaCount:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">  image:</span> <span class="string">servicegraph</span></span><br><span class="line"><span class="attr">  service:</span></span><br><span class="line"><span class="attr">    name:</span> <span class="string">http</span></span><br><span class="line"><span class="attr">    type:</span> <span class="string">ClusterIP</span></span><br><span class="line"><span class="attr">    externalPort:</span> <span class="number">8088</span></span><br><span class="line"><span class="attr">    internalPort:</span> <span class="number">8088</span></span><br><span class="line"><span class="attr">  ingress:</span></span><br><span class="line"><span class="attr">    enabled:</span> <span class="literal">false</span></span><br><span class="line">    <span class="comment"># Used to create an Ingress record.</span></span><br><span class="line"><span class="attr">    hosts:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">servicegraph.local</span></span><br><span class="line"><span class="attr">    annotations:</span></span><br><span class="line">      <span class="comment"># kubernetes.io/ingress.class: nginx</span></span><br><span class="line">      <span class="comment"># kubernetes.io/tls-acme: "true"</span></span><br><span class="line"><span class="attr">    tls:</span></span><br><span class="line">      <span class="comment"># Secrets must be manually created in the namespace.</span></span><br><span class="line">      <span class="comment"># - secretName: servicegraph-tls</span></span><br><span class="line">      <span class="comment">#   hosts:</span></span><br><span class="line">      <span class="comment">#     - servicegraph.local</span></span><br><span class="line"><span class="attr">  resources:</span> <span class="string">&#123;&#125;</span></span><br><span class="line">    <span class="comment"># limits:</span></span><br><span class="line">    <span class="comment">#  cpu: 100m</span></span><br><span class="line">    <span class="comment">#  memory: 128Mi</span></span><br><span class="line">    <span class="comment"># requests:</span></span><br><span class="line">    <span class="comment">#  cpu: 100m</span></span><br><span class="line">    <span class="comment">#  memory: 128Mi</span></span><br><span class="line">  <span class="comment"># prometheus addres</span></span><br><span class="line"><span class="attr">  prometheusAddr:</span> <span class="attr">http://prometheus:9090</span></span><br><span class="line"></span><br><span class="line"><span class="attr">tracing:</span></span><br><span class="line"><span class="attr">  enabled:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">  jaeger:</span></span><br><span class="line"><span class="attr">    enabled:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">    memory:</span></span><br><span class="line"><span class="attr">      max_traces:</span> <span class="number">50000</span></span><br><span class="line"><span class="attr">  replicaCount:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">  image:</span></span><br><span class="line"><span class="attr">    repository:</span> <span class="number">192.168</span><span class="number">.30</span><span class="number">.100</span><span class="string">:8889/jaegertracing/all-in-one</span></span><br><span class="line"><span class="attr">    tag:</span> <span class="number">1.5</span></span><br><span class="line"><span class="attr">  service:</span></span><br><span class="line"><span class="attr">    name:</span> <span class="string">http</span></span><br><span class="line"><span class="attr">    type:</span> <span class="string">ClusterIP</span></span><br><span class="line"><span class="attr">    externalPort:</span> <span class="number">9411</span></span><br><span class="line"><span class="attr">    internalPort:</span> <span class="number">9411</span></span><br><span class="line"><span class="attr">    uiPort:</span> <span class="number">16686</span></span><br><span class="line"><span class="attr">  ingress:</span></span><br><span class="line"><span class="attr">    enabled:</span> <span class="literal">false</span></span><br><span class="line">    <span class="comment"># Used to create an Ingress record.</span></span><br><span class="line"><span class="attr">    hosts:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">zipkin.local</span></span><br><span class="line"><span class="attr">    annotations:</span></span><br><span class="line">      <span class="comment"># kubernetes.io/ingress.class: nginx</span></span><br><span class="line">      <span class="comment"># kubernetes.io/tls-acme: "true"</span></span><br><span class="line"><span class="attr">    tls:</span></span><br><span class="line">      <span class="comment"># Secrets must be manually created in the namespace.</span></span><br><span class="line">      <span class="comment"># - secretName: zipkin-tls</span></span><br><span class="line">      <span class="comment">#   hosts:</span></span><br><span class="line">      <span class="comment">#     - zipkin.local</span></span><br><span class="line"><span class="attr">  resources:</span> <span class="string">&#123;&#125;</span></span><br><span class="line">    <span class="comment"># limits:</span></span><br><span class="line">    <span class="comment">#  cpu: 100m</span></span><br><span class="line">    <span class="comment">#  memory: 128Mi</span></span><br><span class="line">    <span class="comment"># requests:</span></span><br><span class="line">    <span class="comment">#  cpu: 100m</span></span><br><span class="line">    <span class="comment">#  memory: 128Mi</span></span><br></pre></td></tr></table></figure></p><p>主要修改了镜像地址和将以些默认不安装的addon设置为安装(<code>grafana</code>,<code>servicegraph</code>,<code>tracing</code>)<br>安装成功之后<br><figure class="image-bubble">                <div class="img-lightbox">                    <div class="overlay"></div>                    <img src="/img/svc.png" alt="istio svc" title="">                </div>                <div class="image-caption">istio svc</div>            </figure><br><strong><em>为了避免ingressgate-way所在的机子80端口被占用，特申请一台ingressgate-way的IP地址相同机子</em></strong><br><br><strong><em>在dns里添加了主机域名</em></strong></p><h1 id="Mesh-Expansion"><a href="#Mesh-Expansion" class="headerlink" title="Mesh Expansion"></a>Mesh Expansion</h1><p>Istio 还支持管理非 Kubernetes 管理的应用。此时，需要在应用所在的 VM 或者物理中部署 Istio，具体步骤请参考 <a href="https://istio.io/docs/setup/kubernetes/mesh-expansion.html。" target="_blank" rel="noopener">https://istio.io/docs/setup/kubernetes/mesh-expansion.html。</a><br>部署好后，就可以向 Istio 注册应用，如<br><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># istioctl register servicename machine-ip portname:port</span></span><br><span class="line"><span class="string">istioctl</span> <span class="bullet">-n</span> <span class="string">onprem</span> <span class="string">register</span> <span class="string">mysql</span> <span class="number">1.2</span><span class="number">.3</span><span class="number">.4</span> <span class="number">3306</span></span><br><span class="line"><span class="string">istioctl</span> <span class="bullet">-n</span> <span class="string">onprem</span> <span class="string">register</span> <span class="string">svc1</span> <span class="number">1.2</span><span class="number">.3</span><span class="number">.4</span> <span class="attr">http:7000</span></span><br></pre></td></tr></table></figure></p><h1 id="Prometheus、Grafana-和-Zipkin"><a href="#Prometheus、Grafana-和-Zipkin" class="headerlink" title="Prometheus、Grafana 和 Zipkin"></a>Prometheus、Grafana 和 Zipkin</h1><p>等所有 Pod 启动后，可以通过 NodePort、负载均衡服务的外网 IP 或者 kubectl proxy 来访问这些服务或者创建一个istio的VirtualService。<br><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.istio.io/v1alpha3</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Gateway</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">istio-gateway</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  selector:</span></span><br><span class="line"><span class="attr">    istio:</span> <span class="string">ingressgateway</span> <span class="comment"># use istio default controller</span></span><br><span class="line"><span class="attr">  servers:</span></span><br><span class="line"><span class="attr">  - port:</span></span><br><span class="line"><span class="attr">      number:</span> <span class="number">80</span></span><br><span class="line"><span class="attr">      name:</span> <span class="string">http</span></span><br><span class="line"><span class="attr">      protocol:</span> <span class="string">HTTP</span></span><br><span class="line"><span class="attr">    hosts:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">"prom.example.com"</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">"grafana.example.com"</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">"pilot.example.com"</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">"zipkin.example.com"</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.istio.io/v1alpha3</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">VirtualService</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">grafana</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  hosts:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">"grafana.example.com"</span></span><br><span class="line"><span class="attr">  gateways:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">istio-gateway</span></span><br><span class="line"><span class="attr">  http:</span></span><br><span class="line"><span class="attr">  - route:</span></span><br><span class="line"><span class="attr">    - destination:</span></span><br><span class="line"><span class="attr">        host:</span> <span class="string">grafana.istio-system.svc.cluster.local</span></span><br><span class="line"><span class="attr">        port:</span></span><br><span class="line"><span class="attr">          number:</span> <span class="number">3000</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.istio.io/v1alpha3</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">VirtualService</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">prom</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  hosts:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">"prom.example.com"</span></span><br><span class="line"><span class="attr">  gateways:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">istio-gateway</span></span><br><span class="line"><span class="attr">  http:</span></span><br><span class="line"><span class="attr">  - route:</span></span><br><span class="line"><span class="attr">    - destination:</span></span><br><span class="line"><span class="attr">        host:</span> <span class="string">prometheus.istio-system.svc.cluster.local</span></span><br><span class="line"><span class="attr">        port:</span></span><br><span class="line"><span class="attr">          number:</span> <span class="number">9090</span></span><br><span class="line"><span class="meta">---</span></span><br></pre></td></tr></table></figure></p><p>通过 <code>http://grafana.example.com</code> 访问 Grafana 服务<br><figure class="image-bubble">                <div class="img-lightbox">                    <div class="overlay"></div>                    <img src="/img/grafana.png" alt="" title="">                </div>                <div class="image-caption"></div>            </figure></p><p>通过loabblancer访问jaeger-query,展示服务之间调用关系图<br><figure class="image-bubble">                <div class="img-lightbox">                    <div class="overlay"></div>                    <img src="/img/jaeger-query.png" alt="" title="">                </div>                <div class="image-caption"></div>            </figure></p><h1 id="参考文档"><a href="#参考文档" class="headerlink" title="参考文档"></a>参考文档</h1><p><a href="https://istio.io/docs/setup/kubernetes/helm-install/" target="_blank" rel="noopener">官方istio安装</a><br><a href="https://kubernetes.feisky.xyz/zh/apps/istio-deploy.html" target="_blank" rel="noopener">istio安装</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;istio安装&quot;&gt;&lt;a href=&quot;#istio安装&quot; class=&quot;headerlink&quot; title=&quot;istio安装&quot;&gt;&lt;/a&gt;istio安装&lt;/h1&gt;&lt;p&gt;&lt;a href=&quot;https://istio.io/docs/setup/&quot; target=&quot;_bl
      
    
    </summary>
    
      <category term="DevOps" scheme="https://www.zhengyuyan.com/categories/DevOps/"/>
    
    
      <category term="service Mesh" scheme="https://www.zhengyuyan.com/tags/service-Mesh/"/>
    
  </entry>
  
  <entry>
    <title>istio简介(一)</title>
    <link href="https://www.zhengyuyan.com/201807/17/istio-brief/"/>
    <id>https://www.zhengyuyan.com/201807/17/istio-brief/</id>
    <published>2018-07-17T13:17:51.000Z</published>
    <updated>2018-07-17T13:58:14.194Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Istio简介"><a href="#Istio简介" class="headerlink" title="Istio简介"></a>Istio简介</h1><h2 id="Service-Mesh"><a href="#Service-Mesh" class="headerlink" title="Service Mesh"></a>Service Mesh</h2><p>服务网格是一个基础设施层，功能在于处理服务间通信，职责是负责实现请求的可靠传递。在实践中，服务网格通常实现为轻量级网络代理，通常与应用程序部署在一起，但是对应用程序透明。</p><h2 id="Istio是什么"><a href="#Istio是什么" class="headerlink" title="Istio是什么"></a>Istio是什么</h2><p>Istio是一个服务网格.<br>Istio 是一个用来连接、管理和保护微服务的开放平台。<br>Istio 提供一种简单的方式来为已部署的服务建立网络，该网络具有负载均衡、服务间认证、监控等功能，而不需要对服务的代码做任何改动。想要让服务支持 Istio，只需要在您的环境中部署一个特殊的 sidecar，使用 Istio 控制平面功能配置和管理代理，拦截微服务之间的所有网络通信。</p><h2 id="Istio功能"><a href="#Istio功能" class="headerlink" title="Istio功能"></a>Istio功能</h2><p>Istio 提供了一个完整的解决方案，通过为整个服务网格提供行为洞察和操作控制来满足微服务应用程序的多样化需求。它在服务网络中统一提供了许多关键功能：</p><ul><li>流量管理。控制服务之间的流量和API调用的流向，使得调用更可靠，并使网络在恶劣情况下更加健壮。</li><li>服务身份和安全。为网格中的服务提供可验证身份，并提供保护服务流量的能力，使其可以在不同可信度的网络上流转。</li><li>策略执行。将组织策略应用于服务之间的互动，确保访问策略得以执行，资源在消费者之间良好分配。可以通过通过配置网格而不是修改应用程序代码来完成策略的更改。</li><li>遥测：了解服务之间的依赖关系，以及它们之间流量的本质和流向，从而提供快速识别问题的能力。</li></ul><h2 id="Istio体系结构"><a href="#Istio体系结构" class="headerlink" title="Istio体系结构"></a>Istio体系结构</h2><p>Istio 服务网格逻辑上分为数据平面和控制平面。</p><ul><li>数据平面由一组以sidecar方式部署的智能代理（Envoy）组成。这些代理可以调节和控制微服务及 Mixer 之间所有的网络通信。</li><li>控制平面负责管理和配置代理来路由流量。此外控制平面配置 Mixer 以实施策略和收集遥测数据。</li></ul><p>Istio主要由Envoy、Pilot、Mixer三部分组成，整体结构如下：<br><figure class="image-bubble">                <div class="img-lightbox">                    <div class="overlay"></div>                    <img src="/img/arch.png" alt="" title="">                </div>                <div class="image-caption"></div>            </figure></p><ul><li>Envoy：以sidecar的形式和应用程序运行与同一个pod中，通过修改iptables来代理应用程序的所有出入流量</li><li>Pilot：接受系统管理员发出的指令或者规则，遥控所有Envoy的行为</li><li>Mixer：从Envoy处获取流量属性，根据自定义的属性匹配规则进行流量处理，如：流量限制、日志记录等</li></ul><h3 id="Envoy"><a href="#Envoy" class="headerlink" title="Envoy"></a>Envoy</h3><p>Istio利用了Envoy的许多内置功能，例如动态服务发现，负载均衡，TLS termination，HTTP/2&amp;gRPC代理，熔断器，健康检查，基于百分比流量拆分的分段推出，故障注入和丰富的metrics。<br>Envoy实现了过滤和路由、服务发现、健康检查，提供了具有弹性的负载均衡。它在安全上支持TLS，在通信方面支持gRPC.</p><p>概括说，Envoy 提供的是服务间网络通讯的能力，包括(以下均可支持TLS)：</p><ul><li>HTTP／1.1</li><li>HTTP/2</li><li>gRPC</li><li>TCP</li></ul><p>以及网络通讯直接相关的功能：</p><ul><li>服务发现：从Pilot得到服务发现信息</li><li>过滤</li><li>负载均衡</li><li>健康检查</li><li>执行路由规则(Rule): 规则来自Polit,包括路由和目的地策略</li><li>加密和认证: TLS certs来自 istio-Auth</li></ul><h3 id="Pilot-流量管理"><a href="#Pilot-流量管理" class="headerlink" title="Pilot(流量管理)"></a>Pilot(流量管理)</h3><p>Envoy在其中扮演的负责搬砖的民工角色, 而指挥Envoy工作的民工头就是Pilot模块.<br>Pilot负责收集和验证配置并将其传播到各种Istio组件。它从Mixer和Envoy中抽取环境特定的实现细节，为他们提供独立于底层平台的用户服务的抽象表示。此外，流量管理规则（即通用4层规则和7层HTTP/gRPC路由规则）可以在运行时通过Pilot进行编程。<br>每个Envoy实例根据其从Pilot获得的信息以及其负载均衡池中的其他实例的定期健康检查来维护 负载均衡信息，从而允许其在目标实例之间智能分配流量，同时遵循其指定的路由规则。<br>Pilot负责在Istio服务网格中部署的Envoy实例的生命周期。</p><h4 id="Pilot的架构"><a href="#Pilot的架构" class="headerlink" title="Pilot的架构"></a>Pilot的架构</h4><figure class="image-bubble">                <div class="img-lightbox">                    <div class="overlay"></div>                    <img src="/img/PilotAdapters.png" alt="" title="">                </div>                <div class="image-caption"></div>            </figure><ul><li>Envoy API负责和Envoy的通讯, 主要是发送服务发现信息和流量控制规则给Envoy</li><li>Envoy提供服务发现，负载均衡池和路由表的动态更新的API。这些API将istio和Envoy的实现解耦。(另外,也使得 Linkerd 之类的其他服务网络实现得以平滑接管Envoy)</li><li>Polit 定了一个抽象模型, 以从特定平台细节中解耦, 为跨平台提供基础.</li><li>Platform Adapter则是这个抽象模型的现实实现版本, 用于对接外部的不同平台</li><li>最后是 Rules API, 提供接口给外部调用以管理 Pilot, 包括命令行工具istioctl以及未来可能出现的第三方管理界面</li></ul><h4 id="pilot功能"><a href="#pilot功能" class="headerlink" title="pilot功能"></a>pilot功能</h4><p>基于上述的架构设计, pilot提供以下重要功能:</p><ul><li>请求路由</li><li>服务发现和负载均衡</li><li>故障处理</li><li>故障注入</li><li>规则配置</li></ul><h3 id="Mixer"><a href="#Mixer" class="headerlink" title="Mixer"></a>Mixer</h3><figure class="image-bubble">                <div class="img-lightbox">                    <div class="overlay"></div>                    <img src="/img/mixer-logo.png" alt="" title="">                </div>                <div class="image-caption"></div>            </figure><p>Mixer负责在服务网格上执行访问控制和使用策略，并收集Envoy代理和其他服务的遥测数据。</p><h4 id="Mixer的设计背景"><a href="#Mixer的设计背景" class="headerlink" title="Mixer的设计背景"></a>Mixer的设计背景</h4><p>我们的系统通常会基于大量的基础设施而构建, 这些基础设施的后端服务为业务服务提供各种支持功能。包括访问控制系统，遥测捕获系统，配额执行系统，计费系统等。在传统设计中, 服务直接与这些后端系统集成，容易产生硬耦合.<br>在istio中,为了避免应用程序的微服务和基础设施的后端服务之间的耦合, 提供了 Mixer 作为两者的通用中介层:<br><figure class="image-bubble">                <div class="img-lightbox">                    <div class="overlay"></div>                    <img src="/img/mixer-traffic.png" alt="" title="">                </div>                <div class="image-caption"></div>            </figure></p><h4 id="Mixer的功能"><a href="#Mixer的功能" class="headerlink" title="Mixer的功能"></a>Mixer的功能</h4><p>Mixer 提供三个核心功能：</p><ul><li>前提条件检查。允许服务在响应来自服务消费者的传入请求之前验证一些前提条件。前提条件包括认证，黑白名单，ACL检查等等。</li><li>配额管理。使服务能够在多个维度上分配和释放配额。典型例子如限速。</li><li>遥测报告。使服务能够上报日志和监控。<br>在Istio内，Envoy重度依赖Mixer。</li></ul><h3 id="Istio-Auth"><a href="#Istio-Auth" class="headerlink" title="Istio-Auth"></a>Istio-Auth</h3><p>Istio-Auth提供强大的服务到服务和终端用户认证，使用交互TLS，内置身份和凭据管理。它可用于升级服务网格中的未加密流量，并为运维人员提供基于服务身份而不是网络控制实施策略的能力。</p><h4 id="auth的架构"><a href="#auth的架构" class="headerlink" title="auth的架构"></a>auth的架构</h4><p>其中包括三个组件：身份，密钥管理和通信安全。<br><figure class="image-bubble">                <div class="img-lightbox">                    <div class="overlay"></div>                    <img src="/img/auth.png" alt="" title="">                </div>                <div class="image-caption"></div>            </figure></p><h1 id="参考文档"><a href="#参考文档" class="headerlink" title="参考文档"></a>参考文档</h1><p><a href="https://istio.io/docs/concepts/what-is-istio/overview/" target="_blank" rel="noopener">istio官网</a><br><a href="https://skyao.io/publication/istio-introduction/" target="_blank" rel="noopener">服务网格新生代-Istio(敖小剑)</a><br><a href="https://blog.csdn.net/chenleiking/article/details/79785493" target="_blank" rel="noopener">istio简介</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;Istio简介&quot;&gt;&lt;a href=&quot;#Istio简介&quot; class=&quot;headerlink&quot; title=&quot;Istio简介&quot;&gt;&lt;/a&gt;Istio简介&lt;/h1&gt;&lt;h2 id=&quot;Service-Mesh&quot;&gt;&lt;a href=&quot;#Service-Mesh&quot; class=&quot;
      
    
    </summary>
    
      <category term="DevOps" scheme="https://www.zhengyuyan.com/categories/DevOps/"/>
    
    
      <category term="service Mesh" scheme="https://www.zhengyuyan.com/tags/service-Mesh/"/>
    
  </entry>
  
  <entry>
    <title>etcd操作</title>
    <link href="https://www.zhengyuyan.com/201806/29/etcd%E6%93%8D%E4%BD%9C/"/>
    <id>https://www.zhengyuyan.com/201806/29/etcd操作/</id>
    <published>2018-06-29T09:22:39.000Z</published>
    <updated>2018-07-17T13:59:09.889Z</updated>
    
    <content type="html"><![CDATA[<p>今天利用<code>helm</code>去部署一个应用，</p><p>因为一些问题想删掉部署的应用。</p><p>利用<code>helm</code>执行了删除操作后，还有几个顽固红彤彤的pod在那挂着。</p><p>用<code>kubectl</code>去查询<code>pod</code>,</p><p>查询结果显示<code>Error from server (NotFound): pods &quot;istio-pilot-9b8bb4dcb-k2knj&quot; not found</code>。</p><p>呵呵，<code>dashboard</code>刷新n次，</p><p>那<code>pod</code>还在，真是扎眼。</p><p>为了真正的删除资源，只有操作etcd了。</p><p>连上服务器直接<code>ectdctl --help</code>,可以用<code>etcdctl ls</code>试试水，结果</p><figure class="image-bubble">                <div class="img-lightbox">                    <div class="overlay"></div>                    <img src="/img/etcd_1.png" alt="" title="">                </div>                <div class="image-caption"></div>            </figure><p>然后百度一番执行了<code>export ETCDCTL_API=3</code>。</p><p>然后<code>etcdctl get /registry/deployments/default --prefix --keys-only</code></p><figure class="image-bubble">                <div class="img-lightbox">                    <div class="overlay"></div>                    <img src="/img/etcd_2.png" alt="" title="">                </div>                <div class="image-caption"></div>            </figure><p>然后删掉那顽固的pod,ok了</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">etcdctl del  /registry/pods/istio-system/istio-sidecar-injector-7889c4fdf5-gnbpk</span><br><span class="line">etcdctl del  /registry/pods/istio-system/istio-pilot-db45c47d9-bzt9r</span><br><span class="line">etcdctl del  /registry/pods/istio-system/istio-sidecar-injector-645c89bc64-fh298</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;今天利用&lt;code&gt;helm&lt;/code&gt;去部署一个应用，&lt;/p&gt;
&lt;p&gt;因为一些问题想删掉部署的应用。&lt;/p&gt;
&lt;p&gt;利用&lt;code&gt;helm&lt;/code&gt;执行了删除操作后，还有几个顽固红彤彤的pod在那挂着。&lt;/p&gt;
&lt;p&gt;用&lt;code&gt;kubectl&lt;/code&gt;去查
      
    
    </summary>
    
      <category term="DevOps" scheme="https://www.zhengyuyan.com/categories/DevOps/"/>
    
    
      <category term="etcd" scheme="https://www.zhengyuyan.com/tags/etcd/"/>
    
  </entry>
  
  <entry>
    <title>Hello World</title>
    <link href="https://www.zhengyuyan.com/201806/27/hello-world/"/>
    <id>https://www.zhengyuyan.com/201806/27/hello-world/</id>
    <published>2018-06-27T10:31:29.696Z</published>
    <updated>2018-06-27T10:31:29.697Z</updated>
    
    <content type="html"><![CDATA[<p>Welcome to <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a>! This is your very first post. Check <a href="https://hexo.io/docs/" target="_blank" rel="noopener">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a href="https://hexo.io/docs/troubleshooting.html" target="_blank" rel="noopener">troubleshooting</a> or you can ask me on <a href="https://github.com/hexojs/hexo/issues" target="_blank" rel="noopener">GitHub</a>.</p><h2 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h2><h3 id="Create-a-new-post"><a href="#Create-a-new-post" class="headerlink" title="Create a new post"></a>Create a new post</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ hexo new <span class="string">"My New Post"</span></span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/writing.html" target="_blank" rel="noopener">Writing</a></p><h3 id="Run-server"><a href="#Run-server" class="headerlink" title="Run server"></a>Run server</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ hexo server</span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/server.html" target="_blank" rel="noopener">Server</a></p><h3 id="Generate-static-files"><a href="#Generate-static-files" class="headerlink" title="Generate static files"></a>Generate static files</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ hexo generate</span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/generating.html" target="_blank" rel="noopener">Generating</a></p><h3 id="Deploy-to-remote-sites"><a href="#Deploy-to-remote-sites" class="headerlink" title="Deploy to remote sites"></a>Deploy to remote sites</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ hexo deploy</span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/deployment.html" target="_blank" rel="noopener">Deployment</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;Welcome to &lt;a href=&quot;https://hexo.io/&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;Hexo&lt;/a&gt;! This is your very first post. Check &lt;a href=&quot;https://hexo.
      
    
    </summary>
    
    
  </entry>
  
</feed>
